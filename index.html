<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VK Users Analyzer Pro</title>
    <!-- SheetJS для экспорта XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1em;
      }

      .main-content {
        padding: 30px;
      }

      .friend-check-section {
        background: #e8f5e8;
        border: 2px solid #28a745;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        text-align: center;
      }

      .friend-check-section h3 {
        color: #28a745;
        margin-bottom: 15px;
      }

      .friend-input {
        width: 100%;
        max-width: 500px;
        padding: 12px 20px;
        border: 2px solid #28a745;
        border-radius: 25px;
        font-size: 1.1em;
        margin-bottom: 15px;
      }

      .friend-input:focus {
        outline: none;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
      }

      .upload-section {
        background: #f8f9ff;
        border: 2px dashed #4568dc;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
      }

      .upload-section:hover {
        border-color: #b06ab3;
        background: #f0f2ff;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 1.1em;
        cursor: pointer;
        transition: transform 0.3s ease;
        margin: 10px;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(69, 104, 220, 0.3);
      }

      .controls-section {
        background: #f8f9ff;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        display: none;
      }

      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      .control-group label {
        margin-bottom: 5px;
        font-weight: bold;
        color: #4568dc;
      }

      .control-group select,
      .control-group input {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
      }

      .control-group select:focus,
      .control-group input:focus {
        outline: none;
        border-color: #4568dc;
      }

      .view-toggle {
        display: flex;
        background: #e9ecef;
        border-radius: 25px;
        padding: 5px;
        margin: 15px 0;
      }

      .view-btn {
        flex: 1;
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: transparent;
      }

      .view-btn.active {
        background: #4568dc;
        color: white;
      }

      .progress-container {
        margin: 20px 0;
        display: none;
      }

      .progress-bar {
        background: #e0e0e0;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(90deg, #4568dc, #b06ab3);
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #4568dc;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #4568dc;
      }

      .stat-label {
        color: #666;
        margin-top: 5px;
      }

      .results-container {
        margin-top: 30px;
      }

      /* Стили для карточного режима */
      .city-section {
        margin-bottom: 30px;
      }

      .city-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .city-name {
        font-size: 1.3em;
        font-weight: bold;
      }

      .city-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
      }

      .users-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 15px;
      }

      .user-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        transition: transform 0.2s ease;
      }

      .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      }

      .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
        border: 3px solid #f0f0f0;
      }

      .user-info h4 {
        color: #333;
        margin-bottom: 5px;
      }

      .user-info h4 a {
        color: #4568dc;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .user-info h4 a:hover {
        color: #b06ab3;
        text-decoration: underline;
      }

      .user-info p {
        color: #666;
        font-size: 0.9em;
      }

      /* Стили для табличного режима */
      .table-container {
        overflow-x: auto;
        margin-top: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: none;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      .results-table thead {
        background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
        color: white;
      }

      .results-table th,
      .results-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .results-table th {
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.3s ease;
      }

      .results-table th:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .results-table tbody tr:hover {
        background-color: #f8f9ff;
      }

      .results-table .avatar-cell img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .results-table .name-cell a {
        color: #4568dc;
        text-decoration: none;
        font-weight: bold;
      }

      .results-table .name-cell a:hover {
        color: #b06ab3;
        text-decoration: underline;
      }

      .status {
        padding: 10px 20px;
        border-radius: 10px;
        margin: 10px 0;
        text-align: center;
      }

      .status.info {
        background: #e3f2fd;
        color: #1976d2;
      }

      .status.success {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4568dc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .export-buttons {
        display: none;
        gap: 10px;
        margin-top: 20px;
      }

      .export-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .export-btn:hover {
        background: #218838;
      }

      .export-btn.xlsx {
        background: #17a2b8;
      }

      .export-btn.xlsx:hover {
        background: #138496;
      }

      .rate-limit-warning {
        background: #fff3cd;
        color: #856404;
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #ffc107;
      }

      .privacy-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .privacy-open {
        background: #d4edda;
        color: #155724;
      }

      .privacy-partial {
        background: #fff3cd;
        color: #856404;
      }

      .privacy-closed {
        background: #f8d7da;
        color: #721c24;
      }

      .friend-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 10px;
      }

      .friend-yes {
        background: #d1ecf1;
        color: #0c5460;
      }

      .friend-no {
        background: #f8d7da;
        color: #721c24;
      }

      .friend-unknown {
        background: #e2e3e5;
        color: #383d41;
      }

      .sort-indicator {
        margin-left: 5px;
        opacity: 0.5;
      }

      .sort-indicator.active {
        opacity: 1;
      }

      .analytics-section {
        margin-top: 40px;
        padding: 30px;
        background: #f8f9ff;
        border-radius: 20px;
        display: none;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .analytics-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .analytics-card h3 {
        color: #4568dc;
        margin-bottom: 15px;
        text-align: center;
      }

      .search-input {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 1em;
        margin-bottom: 20px;
      }

      .search-input:focus {
        outline: none;
        border-color: #4568dc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🔍 VK Users Analyzer Pro</h1>
        <p>
          Профессиональный анализ пользователей ВКонтакте с проверкой друзей и
          экспортом в Excel
        </p>
      </div>

      <div class="main-content">
        <!-- Секция проверки друзей -->
        <div class="friend-check-section">
          <h3>👥 Проверка друзей (опционально)</h3>
          <p>Введите ссылку на VK профиль для проверки:</p>
          <p>
            <strong>Логика проверки:</strong> у каждого пользователя из списка
            будем смотреть в друзьях и проверять, есть ли там указанный профиль
          </p>
          <input
            type="text"
            id="friendProfileInput"
            class="friend-input"
            placeholder="https://vk.com/id123456 или https://vk.com/username"
          />
          <p>
            <small
              >⚠️ Проверка работает только для открытых профилей. Закрытые
              профили будут помечены как "Профиль закрытый"</small
            >
          </p>
        </div>

        <div class="upload-section">
          <h3>📁 Загрузите CSV файл с профилями ВКонтакте</h3>
          <p>
            Поддерживаемые форматы:<br />
            • <strong>profile_url</strong> - ссылки вида https://vk.com/id123
            или https://vk.com/username<br />
            • <strong>id/user_id</strong> - прямые ID пользователей<br />
            • <strong>name</strong> - имена пользователей (опционально)
          </p>
          <input type="file" id="csvFile" class="file-input" accept=".csv" />
          <button
            class="upload-btn"
            onclick="document.getElementById('csvFile').click()"
          >
            Выбрать CSV файл
          </button>
          <p>
            <small
              >Поддерживаемые форматы: CSV с profile_url, id или username</small
            >
          </p>
        </div>

        <!-- Элементы управления -->
        <div class="controls-section" id="controlsSection">
          <h3 style="color: #4568dc; margin-bottom: 20px">
            🎛️ Управление отображением
          </h3>

          <div class="controls-grid">
            <div class="control-group">
              <label>Группировка:</label>
              <select id="groupBySelect">
                <option value="city">По городу</option>
                <option value="profile_status">По статусу профиля</option>
                <option value="registration_period">
                  По периоду регистрации
                </option>
                <option value="friend_status">По статусу дружбы</option>
                <option value="none">Без группировки</option>
              </select>
            </div>

            <div class="control-group">
              <label>Сортировка:</label>
              <select id="sortBySelect">
                <option value="first_name">По имени</option>
                <option value="last_name">По фамилии</option>
                <option value="online">По онлайн статусу</option>
                <option value="city">По городу</option>
                <option value="id">По ID</option>
                <option value="registration_date">
                  По периоду регистрации
                </option>
                <option value="exact_registration_date">По точной дате</option>
                <option value="profile_status">По статусу профиля</option>
                <option value="friend_status">По статусу дружбы</option>
              </select>
            </div>

            <div class="control-group">
              <label>Порядок:</label>
              <select id="sortOrderSelect">
                <option value="asc">По возрастанию</option>
                <option value="desc">По убыванию</option>
              </select>
            </div>

            <div class="control-group">
              <label>Поиск:</label>
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="Поиск по имени, городу..."
              />
            </div>
          </div>

          <div class="view-toggle">
            <button
              class="view-btn active"
              id="cardViewBtn"
              onclick="switchView('cards')"
            >
              🃏 Карточки
            </button>
            <button
              class="view-btn"
              id="tableViewBtn"
              onclick="switchView('table')"
            >
              📊 Таблица
            </button>
          </div>
        </div>

        <div class="rate-limit-warning">
          ⚠️ <strong>Лимиты VK API (согласно документации):</strong> <br />📊
          <strong>Пользовательские токены:</strong> до 3 запросов/сек, батчи до
          100 пользователей <br />📍
          <strong>Проверка друзей:</strong> дополнительно по 1 запросу на
          каждого пользователя <br />🎯
          <strong>Оптимизация:</strong> увеличенные батчи, правильные поля API,
          обработка всех ошибок
        </div>

        <div class="progress-container" id="progressContainer">
          <p>Обработка пользователей: <span id="progressText">0/0</span></p>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <div class="stats-container" id="statsContainer" style="display: none">
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">Всего пользователей</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="processedUsers">0</div>
            <div class="stat-label">Обработано</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="uniqueCities">0</div>
            <div class="stat-label">Уникальных городов</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="openProfiles">0</div>
            <div class="stat-label">Открытых профилей</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="friendsCount">0</div>
            <div class="stat-label">В друзьях</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="oldestUsers">0</div>
            <div class="stat-label">Старых аккаунтов</div>
          </div>
        </div>

        <div class="status" id="status" style="display: none"></div>

        <!-- Карточный режим -->
        <div class="results-container" id="resultsContainer"></div>

        <!-- Табличный режим -->
        <div class="table-container" id="tableContainer">
          <table class="results-table" id="resultsTable">
            <thead>
              <tr>
                <th onclick="sortTable('avatar')">Фото</th>
                <th onclick="sortTable('name')">
                  Имя <span class="sort-indicator">↕</span>
                </th>
                <th onclick="sortTable('id')">
                  ID <span class="sort-indicator">↕</span>
                </th>
                <th onclick="sortTable('online')">
                  Статус <span class="sort-indicator">↕</span>
                </th>
                <th onclick="sortTable('city')">
                  Город <span class="sort-indicator">↕</span>
                </th>
                <th onclick="sortTable('registration_date')">
                  Период регистрации <span class="sort-indicator">↕</span>
                </th>
                <th onclick="sortTable('exact_registration_date')">
                  Точная дата <span class="sort-indicator">↕</span>
                </th>
                <th onclick="sortTable('profile_status')">
                  Приватность <span class="sort-indicator">↕</span>
                </th>
                <th onclick="sortTable('friend_status')">
                  Дружба <span class="sort-indicator">↕</span>
                </th>
              </tr>
            </thead>
            <tbody id="resultsTableBody"></tbody>
          </table>
        </div>

        <div class="export-buttons" id="exportButtons">
          <button class="export-btn" onclick="exportResults('csv')">
            📄 Экспорт в CSV
          </button>
          <button class="export-btn xlsx" onclick="exportResults('xlsx')">
            📊 Экспорт в Excel
          </button>
        </div>

        <div class="analytics-section" id="analyticsSection">
          <h2 style="text-align: center; margin: 30px 0; color: #4568dc">
            📊 Подробная аналитика
          </h2>
          <div class="analytics-grid">
            <div class="analytics-card">
              <h3>🏙️ Статистика по городам</h3>
              <div id="cityStats"></div>
            </div>
            <div class="analytics-card">
              <h3>🔒 Статус профилей</h3>
              <div id="profileStats"></div>
            </div>
            <div class="analytics-card">
              <h3>📅 Периоды регистрации</h3>
              <div id="registrationStats"></div>
            </div>
            <div class="analytics-card">
              <h3>👥 Статус дружбы</h3>
              <div id="friendshipStats"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Конфигурация API с правильными лимитами согласно документации
      const API_CONFIG = {
        ACCESS_TOKEN:
          "1bb263451bb263451bb2634552188a4cfe11bb21bb26345732659ed5d055a6b40f69c20",
        BASE_URL: "https://api.vk.com/method/",
        VERSION: "5.131",
        RATE_LIMIT: 2.5, // Консервативно для пользовательских токенов (документация: 3/сек)
        BATCH_SIZE: 100, // users.get поддерживает множественные ID
        FRIENDS_BATCH_SIZE: 25, // Для проверки друзей батчами
        MIN_DELAY: 500, // Минимальная задержка 500мс
        MAX_DELAY: 800, // Максимальная задержка 800мс
      }; // ✅ Чисто, без лишнего текста

      // Глобальные переменные для отладки
      let allResults = [];
      let filteredResults = [];
      let processingStats = {
        total: 0,
        processed: 0,
        errors: 0,
        duplicates: 0,
        invalidUrls: 0,
        resolveErrors: 0,
        resolveAttempts: 0,
        apiErrors: 0,
      };
      let friendCheckUserId = null;
      let currentView = "cards";
      let currentSort = { field: "first_name", order: "asc" };

      // Обработчики событий
      document
        .getElementById("csvFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            processCSV(file);
          }
        });

      // Обработчики для элементов управления
      document
        .getElementById("groupBySelect")
        .addEventListener("change", updateDisplay);
      document
        .getElementById("sortBySelect")
        .addEventListener("change", (e) => {
          currentSort.field = e.target.value;
          updateDisplay();
        });
      document
        .getElementById("sortOrderSelect")
        .addEventListener("change", (e) => {
          currentSort.order = e.target.value;
          updateDisplay();
        });
      document.getElementById("searchInput").addEventListener("input", (e) => {
        filterResults(e.target.value);
        updateDisplay();
      });

      // Функция обработки CSV
      async function processCSV(file) {
        // Получаем ID для проверки друзей
        const friendProfile = document
          .getElementById("friendProfileInput")
          .value.trim();
        if (friendProfile) {
          friendCheckUserId = await extractUserIdFromProfile(friendProfile);
          if (friendCheckUserId) {
            showStatus(
              "info",
              `Будет проводиться проверка дружбы с пользователем ID: ${friendCheckUserId}`
            );
          } else {
            showStatus(
              "error",
              "Не удалось определить ID из введенного профиля"
            );
            return;
          }
        }

        showStatus("info", "Загрузка CSV файла...");

        const text = await file.text();
        const lines = text.split("\n").filter((line) => line.trim());

        if (lines.length === 0) {
          showStatus("error", "Файл пуст");
          return;
        }

        // Парсинг CSV
        function parseCSVLine(line) {
          const result = [];
          let current = "";
          let inQuotes = false;

          for (let i = 0; i < line.length; i++) {
            const char = line[i];

            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === "," && !inQuotes) {
              result.push(current.trim());
              current = "";
            } else {
              current += char;
            }
          }
          result.push(current.trim());
          return result;
        }

        const headers = parseCSVLine(lines[0]).map((h) =>
          h.toLowerCase().replace(/"/g, "")
        );
        let userDataIndex = -1;
        let nameIndex = -1;

        // Поиск столбцов
        const urlColumns = ["profile_url", "url", "link", "vk_url", "vk_link"];
        const idColumns = ["id", "user_id", "userid", "vk_id", "vkid"];
        const nameColumns = ["name", "username", "full_name", "имя"];

        // Поиск нужных столбцов
        for (let col of urlColumns) {
          const index = headers.findIndex((h) => h.includes(col));
          if (index !== -1) {
            userDataIndex = index;
            break;
          }
        }

        if (userDataIndex === -1) {
          for (let col of idColumns) {
            const index = headers.findIndex((h) => h.includes(col));
            if (index !== -1) {
              userDataIndex = index;
              break;
            }
          }
        }

        for (let col of nameColumns) {
          const index = headers.findIndex((h) => h.includes(col));
          if (index !== -1) {
            nameIndex = index;
            break;
          }
        }

        if (userDataIndex === -1) {
          showStatus("error", "Не найден столбец с ID/URL пользователей");
          return;
        }

        showStatus("info", "Извлечение ID пользователей из данных...");

        // Извлечение ID
        const userIds = [];
        const userNames = {};
        const invalidRows = [];
        let emptyRows = 0;

        showStatus("info", "Анализ строк CSV файла...");

        for (let i = 1; i < lines.length; i++) {
          const cols = parseCSVLine(lines[i]);

          if (!cols[userDataIndex] || !cols[userDataIndex].trim()) {
            emptyRows++;
            continue;
          }

          const userData = cols[userDataIndex].replace(/"/g, "").trim();

          // Показываем прогресс каждые 100 строк
          if (i % 100 === 0) {
            showStatus(
              "info",
              `Анализ строки ${i} из ${lines.length - 1}... (найдено ID: ${
                userIds.length
              })`
            );
          }

          let userId = await extractUserIdFromProfile(userData);

          if (userId) {
            userIds.push(userId);
            if (nameIndex !== -1 && cols[nameIndex]) {
              const name = cols[nameIndex].replace(/"/g, "").trim();
              if (name) {
                userNames[userId] = name;
              }
            }
          } else {
            invalidRows.push({
              row: i,
              data: userData,
              originalData: cols[userDataIndex], // Сохраняем оригинальные данные
            });
            processingStats.invalidUrls++;
          }
        }

        // Удаление дубликатов с подсчетом
        const uniqueIds = [];
        const seenIds = new Set();
        userIds.forEach((id) => {
          if (!seenIds.has(id)) {
            uniqueIds.push(id);
            seenIds.add(id);
          } else {
            processingStats.duplicates++;
          }
        });

        // Детальный отчет
        let reportMessage = `
      📊 Анализ CSV завершен:
      • Всего строк в файле: ${lines.length - 1}
      • Пустых строк: ${emptyRows}
      • Некорректных URL/ID: ${processingStats.invalidUrls}
      • Дубликатов: ${processingStats.duplicates}
      • Уникальных пользователей: ${uniqueIds.length}
              `.trim();

        if (invalidRows.length > 0) {
          reportMessage += `\n\n❌ Примеры некорректных строк:`;
          invalidRows.slice(0, 5).forEach((invalid) => {
            const displayData = invalid.originalData || invalid.data;
            reportMessage += `\n• Строка ${invalid.row}: "${
              displayData.length > 50
                ? displayData.substring(0, 50) + "..."
                : displayData
            }"`;
          });
          if (invalidRows.length > 5) {
            reportMessage += `\n• ... и еще ${invalidRows.length - 5} строк`;
          }
          reportMessage += `\n\n💡 Совет: проверьте формат URL - поддерживаются vk.com/username, vk.com/id123456, и прямые ID`;
        }

        showStatus("info", reportMessage);

        processingStats = {
          total: uniqueIds.length,
          processed: 0,
          errors: 0,
          duplicates: processingStats.duplicates,
          invalidUrls: processingStats.invalidUrls,
          resolveErrors: processingStats.resolveErrors,
          resolveAttempts: processingStats.resolveAttempts || 0,
          apiErrors: 0,
        };

        updateStats();
        await processUsers(uniqueIds, userNames);
      }

      // Функция извлечения ID из профиля с максимально гибким парсингом
      async function extractUserIdFromProfile(userData) {
        if (!userData || userData === "") return null;

        // Очистка и нормализация данных
        userData = userData.trim().replace(/['"]/g, "");

        // Прямой ID - только цифры
        if (/^\d+$/.test(userData)) {
          return userData;
        }

        // Расширенная обработка всех форматов VK URL
        let username = null;

        // Паттерны для извлечения username/id из разных форматов URL
        const patterns = [
          // Полные URL с https/http и www/m
          /(?:https?:\/\/)(?:www\.|m\.)?vk\.com\/([^\/\?&#]+)/i,
          /(?:https?:\/\/)(?:www\.|m\.)?vkontakte\.ru\/([^\/\?&#]+)/i,

          // Короткие URL без протокола
          /(?:www\.|m\.)?vk\.com\/([^\/\?&#]+)/i,
          /(?:www\.|m\.)?vkontakte\.ru\/([^\/\?&#]+)/i,

          // Еще более короткие формы
          /vk\.com\/([^\/\?&#]+)/i,
          /vkontakte\.ru\/([^\/\?&#]+)/i,

          // ID в формате id123456
          /^id(\d+)$/i,

          // Просто username без префиксов
          /^([a-zA-Z0-9_.-]+)$/,
        ];

        // Пробуем каждый паттерн
        for (let pattern of patterns) {
          const match = userData.match(pattern);
          if (match && match[1]) {
            username = match[1].toLowerCase();
            break;
          }
        }

        if (!username) return null;

        // Если это ID с префиксом "id"
        if (username.startsWith("id")) {
          const idMatch = username.match(/^id(\d+)$/);
          if (idMatch && idMatch[1]) {
            return idMatch[1];
          }
        }

        // Если это прямой числовой ID
        if (/^\d+$/.test(username)) {
          return username;
        }

        // Фильтруем очевидно неподходящие username'ы
        if (username.length < 3 || username.length > 32) {
          return null;
        }

        // Проверяем допустимые символы для VK username
        if (!/^[a-zA-Z0-9_.-]+$/.test(username)) {
          return null;
        }

        // Резолвим username через API с задержкой
        try {
          // Добавляем небольшую задержку между резолвами чтобы не заблокироваться
          if (
            processingStats.resolveAttempts > 0 &&
            processingStats.resolveAttempts % 5 === 0
          ) {
            await sleep(200); // Пауза каждые 5 резолвов
          }

          processingStats.resolveAttempts =
            (processingStats.resolveAttempts || 0) + 1;

          const resolvedId = await resolveUsernameWithJSONP(username);
          if (!resolvedId) {
            processingStats.resolveErrors++;
            console.warn(
              `Не удалось разрешить username: ${username} из ${userData}`
            );
          }
          return resolvedId;
        } catch (error) {
          processingStats.resolveErrors++;
          console.error(`Ошибка при резолве username ${username}:`, error);
          return null;
        }
      }

      // Функция обработки пользователей
      async function processUsers(userIds, csvNames = {}) {
        document.getElementById("progressContainer").style.display = "block";
        document.getElementById("statsContainer").style.display = "grid";
        document.getElementById("controlsSection").style.display = "block";

        allResults = [];

        // Резолвим username'ы
        const resolvedIds = userIds.filter((id) => id);

        // Обрабатываем батчами
        for (let i = 0; i < resolvedIds.length; i += API_CONFIG.BATCH_SIZE) {
          const batch = resolvedIds.slice(i, i + API_CONFIG.BATCH_SIZE);

          try {
            const batchNumber = Math.floor(i / API_CONFIG.BATCH_SIZE) + 1;
            const totalBatches = Math.ceil(
              resolvedIds.length / API_CONFIG.BATCH_SIZE
            );

            showStatus(
              "info",
              `Обработка батча ${batchNumber}/${totalBatches}: пользователи ${
                i + 1
              }-${Math.min(i + API_CONFIG.BATCH_SIZE, resolvedIds.length)} из ${
                resolvedIds.length
              }...`
            );

            const users = await fetchUsersBatch(batch, csvNames);

            // Проверяем дружбу если нужно
            if (friendCheckUserId && users.length > 0) {
              showStatus("info", `Проверка друзей для батча ${batchNumber}...`);
              await checkFriendship(users, friendCheckUserId);
            }

            allResults.push(...users);
            processingStats.processed += users.length;

            // Показываем промежуточную статистику
            updateProgress();
            updateStats();

            // Задержка между батчами
            await sleep(getRandomDelay());
          } catch (error) {
            console.error("Ошибка при обработке батча:", error);
            processingStats.errors += batch.length;
            processingStats.apiErrors += batch.length;

            showStatus(
              "error",
              `Ошибка батча ${Math.floor(i / API_CONFIG.BATCH_SIZE) + 1}: ${
                error.message
              }`
            );

            // Продолжаем обработку следующих батчей
            await sleep(getRandomDelay() * 2); // Больше задержка при ошибке
          }
        }

        // Завершение с детальным отчетом
        filteredResults = [...allResults];
        updateDisplay();
        displayAnalytics(allResults);

        const finalReport = `
        🎉 Обработка завершена!

        📊 ДЕТАЛЬНАЯ СТАТИСТИКА:
        • К обработке: ${processingStats.total}
        • Успешно обработано: ${processingStats.processed}
      • Некорректных URL: ${processingStats.invalidUrls}
      • Попыток резолва username: ${processingStats.resolveAttempts || 0}
      • Ошибок резолва: ${processingStats.resolveErrors}
      • Дубликатов: ${processingStats.duplicates}
      • К обработке: ${processingStats.total}
      • Успешно обработано: ${processingStats.processed}
      • API ошибок: ${processingStats.apiErrors}

      ✅ Итого в таблице: ${allResults.length} пользователей
      ${
        friendCheckUserId
          ? `\n👥 Проверка друзей с ID ${friendCheckUserId} завершена`
          : ""
      }

      ${
        invalidRows.length > 0
          ? `\n🔍 РЕКОМЕНДАЦИИ ПО УЛУЧШЕНИЮ:
      • Проверьте формат некорректных URL в CSV
      • Убедитесь что профили существуют и доступны
      • Некоторые username могли быть изменены владельцами`
          : ""
      }
              `.trim();

        showStatus("success", finalReport);
        document.getElementById("exportButtons").style.display = "flex";
      }

      // JSONP функция для резолва username
      function resolveUsernameWithJSONP(username) {
        return new Promise((resolve, reject) => {
          const callbackName =
            "vk_callback_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);

          window[callbackName] = function (response) {
            document.head.removeChild(script);
            delete window[callbackName];

            if (response.error) {
              resolve(null);
              return;
            }

            if (response.response && response.response.type === "user") {
              resolve(response.response.object_id.toString());
            } else {
              resolve(null);
            }
          };

          const script = document.createElement("script");
          script.src = `${
            API_CONFIG.BASE_URL
          }utils.resolveScreenName?screen_name=${encodeURIComponent(
            username
          )}&access_token=${API_CONFIG.ACCESS_TOKEN}&v=${
            API_CONFIG.VERSION
          }&callback=${callbackName}`;

          script.onerror = function () {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve(null);
          };

          document.head.appendChild(script);

          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              resolve(null);
            }
          }, 10000);
        });
      }

      // Функция получения пользователей с правильными полями согласно документации
      async function fetchUsersBatch(userIds, csvNames = {}) {
        return new Promise((resolve, reject) => {
          const callbackName =
            "vk_users_callback_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);

          window[callbackName] = function (response) {
            document.head.removeChild(script);
            delete window[callbackName];

            if (response.error) {
              reject(new Error(response.error.error_msg));
              return;
            }

            const users = response.response.map((user) => {
              // Более точное определение даты регистрации
              let registrationPeriod = "Неизвестно";
              let estimatedDate = null;
              let exactDate = null;

              if (user.id) {
                // Детальная система определения даты по ID
                const id = user.id;

                if (id <= 50) {
                  registrationPeriod = "Октябрь 2006 (Основатели)";
                  exactDate = "2006-10-10";
                } else if (id <= 100) {
                  registrationPeriod = "Ноябрь 2006 (Первые 100)";
                  exactDate = "2006-11-15";
                } else if (id <= 500) {
                  registrationPeriod = "Декабрь 2006";
                  exactDate = "2006-12-01";
                } else if (id <= 1000) {
                  registrationPeriod = "Январь 2007";
                  exactDate = "2007-01-15";
                } else if (id <= 5000) {
                  registrationPeriod = "Февраль-Март 2007";
                  exactDate = "2007-02-15";
                } else if (id <= 10000) {
                  registrationPeriod = "Апрель-Май 2007";
                  exactDate = "2007-04-15";
                } else if (id <= 50000) {
                  registrationPeriod = "Лето 2007";
                  exactDate = "2007-07-01";
                } else if (id <= 100000) {
                  registrationPeriod = "Осень 2007";
                  exactDate = "2007-09-15";
                } else if (id <= 500000) {
                  registrationPeriod = "Зима 2007-2008";
                  exactDate = "2008-01-01";
                } else if (id <= 1000000) {
                  registrationPeriod = "Весна 2008";
                  exactDate = "2008-04-01";
                } else if (id <= 5000000) {
                  registrationPeriod = "2008-2009";
                  exactDate = "2008-10-01";
                } else if (id <= 10000000) {
                  registrationPeriod = "2009-2010";
                  exactDate = "2009-06-01";
                } else if (id <= 25000000) {
                  registrationPeriod = "2010-2011";
                  exactDate = "2010-08-01";
                } else if (id <= 50000000) {
                  registrationPeriod = "2011-2012";
                  exactDate = "2011-10-01";
                } else if (id <= 100000000) {
                  registrationPeriod = "2012-2014";
                  exactDate = "2013-03-01";
                } else if (id <= 200000000) {
                  registrationPeriod = "2014-2016";
                  exactDate = "2015-01-01";
                } else if (id <= 300000000) {
                  registrationPeriod = "2016-2018";
                  exactDate = "2017-01-01";
                } else if (id <= 400000000) {
                  registrationPeriod = "2018-2020";
                  exactDate = "2019-01-01";
                } else if (id <= 500000000) {
                  registrationPeriod = "2020-2022";
                  exactDate = "2021-01-01";
                } else if (id <= 600000000) {
                  registrationPeriod = "2022-2023";
                  exactDate = "2022-06-01";
                } else {
                  registrationPeriod = "2023+";
                  exactDate = "2023-01-01";
                }

                estimatedDate = exactDate;
              }

              let profileStatus = "Открытый";
              if (user.is_closed) {
                profileStatus = user.can_access_closed
                  ? "Частично закрытый"
                  : "Закрытый";
              }

              const csvName =
                csvNames[user.id] || csvNames[user.domain] || null;
              const firstName = csvName
                ? csvName.split(" ")[0]
                : user.first_name;
              const lastName = csvName
                ? csvName.split(" ").slice(1).join(" ")
                : user.last_name;

              return {
                id: user.id,
                first_name: firstName,
                last_name: lastName,
                photo: user.photo_50,
                city: user.city ? user.city.title : null,
                registration_period: registrationPeriod,
                registration_date: estimatedDate,
                exact_registration_date: exactDate,
                profile_status: profileStatus,
                is_closed: user.is_closed || false,
                domain: user.domain || user.screen_name || null,
                csv_name: csvName,
                friend_status: "Неизвестно",
                vk_url: `https://vk.com/id${user.id}`,
                last_seen: user.last_seen
                  ? new Date(user.last_seen.time * 1000).toLocaleDateString(
                      "ru-RU"
                    )
                  : null,
                online: user.online || 0,
              };
            });

            resolve(users);
          };

          const script = document.createElement("script");
          // Используем правильные поля согласно документации
          const fields =
            "city,photo_50,can_access_closed,is_closed,domain,screen_name,last_seen,online";
          script.src = `${API_CONFIG.BASE_URL}users.get?user_ids=${userIds.join(
            ","
          )}&fields=${fields}&access_token=${API_CONFIG.ACCESS_TOKEN}&v=${
            API_CONFIG.VERSION
          }&callback=${callbackName}`;

          script.onerror = function () {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error("Ошибка загрузки скрипта"));
          };

          document.head.appendChild(script);

          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error("Timeout запроса"));
            }
          }, 15000);
        });
      }

      // Функция проверки дружбы - правильная логика
      async function checkFriendship(users, checkUserId) {
        if (!checkUserId) return users;

        showStatus(
          "info",
          `Проверка дружбы у ${users.length} пользователей...`
        );

        // Проверяем батчами, но по одному пользователю
        for (let i = 0; i < users.length; i++) {
          const user = users[i];

          try {
            // Показываем прогресс
            if (i % 10 === 0) {
              showStatus(
                "info",
                `Проверка друзей: ${i + 1}/${users.length} (${
                  user.first_name
                } ${user.last_name})`
              );
            }

            const friendStatus = await checkUserFriends(user.id, checkUserId);
            user.friend_status = friendStatus;

            // Задержка между запросами
            await sleep(getRandomDelay());
          } catch (error) {
            console.error(
              `Ошибка проверки друзей для пользователя ${user.id}:`,
              error
            );
            user.friend_status = "Ошибка проверки";
          }
        }

        return users;
      }

      // Проверка друзей конкретного пользователя с правильными параметрами API
      function checkUserFriends(userId, targetId) {
        return new Promise((resolve, reject) => {
          const callbackName =
            "vk_user_friends_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);

          window[callbackName] = function (response) {
            document.head.removeChild(script);
            delete window[callbackName];

            if (response.error) {
              // Обработка ошибок согласно документации VK API
              switch (response.error.error_code) {
                case 30: // Profile is private
                  resolve("Профиль закрытый");
                  break;
                case 18: // User was deleted or banned
                  resolve("Пользователь удален/заблокирован");
                  break;
                case 15: // Access denied
                  resolve("Доступ запрещен");
                  break;
                case 6: // Too many requests per second
                  resolve("Лимит запросов");
                  break;
                default:
                  resolve("Ошибка API: " + response.error.error_msg);
              }
              return;
            }

            // Проверяем есть ли targetId в списке друзей
            if (response.response && response.response.items) {
              const isFriend = response.response.items.includes(
                parseInt(targetId)
              );
              resolve(isFriend ? "Друзья" : "Не друзья");
            } else if (response.response && Array.isArray(response.response)) {
              // Старый формат ответа (только ID)
              const isFriend = response.response.includes(parseInt(targetId));
              resolve(isFriend ? "Друзья" : "Не друзья");
            } else {
              resolve("Нет данных о друзьях");
            }
          };

          const script = document.createElement("script");
          // Используем правильные параметры согласно документации friends.get
          script.src = `${API_CONFIG.BASE_URL}friends.get?user_id=${userId}&count=5000&access_token=${API_CONFIG.ACCESS_TOKEN}&v=${API_CONFIG.VERSION}&callback=${callbackName}`;

          script.onerror = function () {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve("Ошибка сети");
          };

          document.head.appendChild(script);

          // Timeout через 10 секунд
          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              resolve("Timeout");
            }
          }, 10000);
        });
      }

      // Функция переключения режимов просмотра
      function switchView(viewType) {
        currentView = viewType;

        const cardViewBtn = document.getElementById("cardViewBtn");
        const tableViewBtn = document.getElementById("tableViewBtn");
        const resultsContainer = document.getElementById("resultsContainer");
        const tableContainer = document.getElementById("tableContainer");

        if (viewType === "cards") {
          cardViewBtn.classList.add("active");
          tableViewBtn.classList.remove("active");
          resultsContainer.style.display = "block";
          tableContainer.style.display = "none";
        } else {
          tableViewBtn.classList.add("active");
          cardViewBtn.classList.remove("active");
          resultsContainer.style.display = "none";
          tableContainer.style.display = "block";
        }

        updateDisplay();
      }

      // Функция фильтрации результатов
      function filterResults(searchTerm) {
        if (!searchTerm.trim()) {
          filteredResults = [...allResults];
          return;
        }

        const term = searchTerm.toLowerCase();
        filteredResults = allResults.filter((user) => {
          return (
            user.first_name.toLowerCase().includes(term) ||
            user.last_name.toLowerCase().includes(term) ||
            (user.city && user.city.toLowerCase().includes(term)) ||
            user.id.toString().includes(term) ||
            user.profile_status.toLowerCase().includes(term) ||
            user.friend_status.toLowerCase().includes(term)
          );
        });
      }

      // Функция сортировки результатов
      function sortResults(results) {
        return [...results].sort((a, b) => {
          let aVal = a[currentSort.field];
          let bVal = b[currentSort.field];

          // Обработка особых случаев
          if (currentSort.field === "name") {
            aVal = a.first_name + " " + a.last_name;
            bVal = b.first_name + " " + b.last_name;
          }

          if (aVal === null || aVal === undefined) aVal = "";
          if (bVal === null || bVal === undefined) bVal = "";

          // Сортировка
          let comparison = 0;
          if (typeof aVal === "string" && typeof bVal === "string") {
            comparison = aVal.localeCompare(bVal, "ru");
          } else {
            comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
          }

          return currentSort.order === "desc" ? -comparison : comparison;
        });
      }

      // Функция обновления отображения
      function updateDisplay() {
        const groupBy = document.getElementById("groupBySelect").value;
        let displayResults = sortResults(filteredResults);

        if (currentView === "cards") {
          displayCardsView(displayResults, groupBy);
        } else {
          displayTableView(displayResults);
        }
      }

      // Отображение в режиме карточек
      function displayCardsView(results, groupBy) {
        const container = document.getElementById("resultsContainer");
        container.innerHTML = "";

        if (groupBy === "none") {
          // Без группировки
          const usersGrid = document.createElement("div");
          usersGrid.className = "users-grid";

          results.forEach((user) => {
            usersGrid.appendChild(createUserCard(user));
          });

          container.appendChild(usersGrid);
        } else {
          // С группировкой
          const groups = {};
          results.forEach((user) => {
            const groupKey = user[groupBy] || "Не указано";
            if (!groups[groupKey]) groups[groupKey] = [];
            groups[groupKey].push(user);
          });

          const sortedGroups = Object.entries(groups).sort(
            ([, a], [, b]) => b.length - a.length
          );

          sortedGroups.forEach(([groupName, users]) => {
            const citySection = document.createElement("div");
            citySection.className = "city-section";

            const cityHeader = document.createElement("div");
            cityHeader.className = "city-header";
            cityHeader.innerHTML = `
                    <span class="city-name">${groupName}</span>
                    <span class="city-count">${users.length} чел.</span>
                  `;

            const usersGrid = document.createElement("div");
            usersGrid.className = "users-grid";

            users.forEach((user) => {
              usersGrid.appendChild(createUserCard(user));
            });

            citySection.appendChild(cityHeader);
            citySection.appendChild(usersGrid);
            container.appendChild(citySection);
          });
        }
      }

      // Создание карточки пользователя
      function createUserCard(user) {
        const userCard = document.createElement("div");
        userCard.className = "user-card";

        let privacyClass = "privacy-open";
        if (user.profile_status === "Закрытый") privacyClass = "privacy-closed";
        else if (user.profile_status === "Частично закрытый")
          privacyClass = "privacy-partial";

        let friendBadge = "";
        if (user.friend_status !== "Неизвестно") {
          let friendClass = "friend-unknown";
          if (user.friend_status === "Друзья") friendClass = "friend-yes";
          else if (user.friend_status === "Не друзья")
            friendClass = "friend-no";

          friendBadge = `<span class="friend-badge ${friendClass}">${user.friend_status}</span>`;
        }

        userCard.innerHTML = `
                <img src="${user.photo || "https://via.placeholder.com/50"}"
                     alt="${user.first_name}"
                     class="user-avatar"
                     onerror="this.src='https://via.placeholder.com/50'">
                <div class="user-info">
                    <h4><a href="${user.vk_url}" target="_blank">${
          user.first_name
        } ${user.last_name}</a> ${user.online ? "🟢" : ""}</h4>
                    <p>ID: ${user.id} | ${user.city || "Город не указан"}</p>
                    <p>📅 ${user.registration_period}</p>
                    ${
                      user.exact_registration_date
                        ? `<p style="font-size: 0.85em; color: #555;">Точная дата: ${user.exact_registration_date}</p>`
                        : ""
                    }
                    ${
                      user.last_seen
                        ? `<p style="font-size: 0.85em; color: #666;">Последний визит: ${user.last_seen}</p>`
                        : ""
                    }
                    ${
                      user.csv_name
                        ? `<p style="font-size: 0.8em; color: #888;">CSV: ${user.csv_name}</p>`
                        : ""
                    }
                    <div style="margin-top: 8px;">
                      <span class="privacy-badge ${privacyClass}">${
          user.profile_status
        }</span>
                      ${friendBadge}
                    </div>
                </div>
              `;
        return userCard;
      }

      // Отображение в табличном режиме
      function displayTableView(results) {
        const tbody = document.getElementById("resultsTableBody");
        tbody.innerHTML = "";

        results.forEach((user) => {
          const row = document.createElement("tr");

          let privacyClass = "privacy-open";
          if (user.profile_status === "Закрытый")
            privacyClass = "privacy-closed";
          else if (user.profile_status === "Частично закрытый")
            privacyClass = "privacy-partial";

          let friendClass = "friend-unknown";
          if (user.friend_status === "Друзья") friendClass = "friend-yes";
          else if (user.friend_status === "Не друзья")
            friendClass = "friend-no";

          row.innerHTML = `
                  <td class="avatar-cell">
                    <img src="${user.photo || "https://via.placeholder.com/40"}"
                         alt="${user.first_name}"
                         onerror="this.src='https://via.placeholder.com/40'">
                  </td>
                  <td class="name-cell">
                    <a href="${user.vk_url}" target="_blank">${
            user.first_name
          } ${user.last_name}</a>
                    ${
                      user.csv_name
                        ? `<br><small style="color: #888;">CSV: ${user.csv_name}</small>`
                        : ""
                    }
                  </td>
                  <td>${user.id}</td>
                  <td>
                    ${
                      user.online
                        ? '<span style="color: #28a745;">🟢 Онлайн</span>'
                        : '<span style="color: #6c757d;">⚫ Оффлайн</span>'
                    }
                    ${
                      user.last_seen
                        ? `<br><small style="color: #888;">${user.last_seen}</small>`
                        : ""
                    }
                  </td>
                  <td>${user.city || "Не указан"}</td>
                  <td>${user.registration_period}</td>
                  <td>${
                    user.exact_registration_date ||
                    user.registration_date ||
                    "Неизвестно"
                  }</td>
                  <td><span class="privacy-badge ${privacyClass}">${
            user.profile_status
          }</span></td>
                  <td><span class="friend-badge ${friendClass}">${
            user.friend_status
          }</span></td>
                `;

          tbody.appendChild(row);
        });
      }

      // Функция сортировки таблицы
      function sortTable(field) {
        if (field === "name") field = "first_name";
        if (field === "avatar") return; // Нельзя сортировать по фото

        if (currentSort.field === field) {
          currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
        } else {
          currentSort.field = field;
          currentSort.order = "asc";
        }

        // Обновляем селекторы
        document.getElementById("sortBySelect").value = field;
        document.getElementById("sortOrderSelect").value = currentSort.order;

        updateDisplay();
      }

      // Функция экспорта результатов
      function exportResults(format) {
        if (format === "csv") {
          exportToCSV();
        } else if (format === "xlsx") {
          exportToXLSX();
        }
      }

      function exportToCSV() {
        let csv =
          "Имя,Фамилия,ID,Онлайн,Город,Период_регистрации,Точная_дата_регистрации,Последний_визит,Статус_профиля,Статус_дружбы,Ссылка,Фото\n";

        filteredResults.forEach((user) => {
          const onlineStatus = user.online ? "Онлайн" : "Оффлайн";
          csv += `"${user.first_name}","${user.last_name}",${
            user.id
          },"${onlineStatus}","${user.city || "Не указан"}","${
            user.registration_period
          }","${user.exact_registration_date || user.registration_date}","${
            user.last_seen || ""
          }","${user.profile_status}","${user.friend_status}","${
            user.vk_url
          }","${user.photo || ""}"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        downloadFile(
          blob,
          `vk_users_analysis_${new Date().toISOString().split("T")[0]}.csv`
        );
      }

      function exportToXLSX() {
        const ws_data = [
          [
            "Имя",
            "Фамилия",
            "ID",
            "Онлайн",
            "Город",
            "Период регистрации",
            "Точная дата",
            "Последний визит",
            "Статус профиля",
            "Статус дружбы",
            "Ссылка",
            "Фото",
          ],
        ];

        filteredResults.forEach((user) => {
          const onlineStatus = user.online ? "Онлайн" : "Оффлайн";
          ws_data.push([
            user.first_name,
            user.last_name,
            user.id,
            onlineStatus,
            user.city || "Не указан",
            user.registration_period,
            user.exact_registration_date || user.registration_date,
            user.last_seen || "",
            user.profile_status,
            user.friend_status,
            user.vk_url,
            user.photo || "",
          ]);
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);

        // Автоширина колонок
        const colWidths = [];
        for (let i = 0; i < ws_data[0].length; i++) {
          let maxLength = 0;
          for (let j = 0; j < ws_data.length; j++) {
            if (ws_data[j][i]) {
              maxLength = Math.max(maxLength, ws_data[j][i].toString().length);
            }
          }
          colWidths.push({ width: Math.min(maxLength + 2, 50) });
        }
        ws["!cols"] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, "VK Users");

        XLSX.writeFile(
          wb,
          `vk_users_analysis_${new Date().toISOString().split("T")[0]}.xlsx`
        );
      }

      function downloadFile(blob, filename) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      // Аналитика
      function displayAnalytics(users) {
        document.getElementById("analyticsSection").style.display = "block";

        displayCityAnalytics(users);
        displayProfileAnalytics(users);
        displayRegistrationAnalytics(users);
        displayFriendshipAnalytics(users);
      }

      function displayCityAnalytics(users) {
        const cityStats = {};
        users.forEach((user) => {
          const city = user.city || "Не указан";
          cityStats[city] = (cityStats[city] || 0) + 1;
        });

        const container = document.getElementById("cityStats");
        container.innerHTML = "";

        const sortedCities = Object.entries(cityStats)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 10);

        sortedCities.forEach(([city, count]) => {
          const cityDiv = document.createElement("div");
          cityDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <span>${city}</span>
                    <span style="font-weight: bold; color: #4568dc;">${count}</span>
                  </div>
                `;
          container.appendChild(cityDiv);
        });
      }

      function displayProfileAnalytics(users) {
        const profileStats = {};
        users.forEach((user) => {
          const status = user.profile_status;
          profileStats[status] = (profileStats[status] || 0) + 1;
        });

        const container = document.getElementById("profileStats");
        container.innerHTML = "";

        Object.entries(profileStats).forEach(([status, count]) => {
          const percentage = ((count / users.length) * 100).toFixed(1);
          const statusDiv = document.createElement("div");
          statusDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span>${status}</span>
                    <span style="font-weight: bold; color: #4568dc;">${count} (${percentage}%)</span>
                  </div>
                `;
          container.appendChild(statusDiv);
        });
      }

      function displayRegistrationAnalytics(users) {
        const regStats = {};
        users.forEach((user) => {
          const period = user.registration_period;
          regStats[period] = (regStats[period] || 0) + 1;
        });

        const container = document.getElementById("registrationStats");
        container.innerHTML = "";

        const sortedPeriods = Object.entries(regStats).sort(([a], [b]) =>
          a.localeCompare(b)
        );

        sortedPeriods.forEach(([period, count]) => {
          const percentage = ((count / users.length) * 100).toFixed(1);
          const periodDiv = document.createElement("div");
          periodDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span>${period}</span>
                    <span style="font-weight: bold; color: #4568dc;">${count} (${percentage}%)</span>
                  </div>
                `;
          container.appendChild(periodDiv);
        });
      }

      function displayFriendshipAnalytics(users) {
        const friendStats = {};
        let totalFriends = 0;
        let totalChecked = 0;
        let closedProfiles = 0;
        let accessErrors = 0;

        users.forEach((user) => {
          const status = user.friend_status;
          friendStats[status] = (friendStats[status] || 0) + 1;

          if (status !== "Неизвестно") {
            totalChecked++;
            if (status === "Друзья") {
              totalFriends++;
            } else if (status === "Профиль закрытый") {
              closedProfiles++;
            } else if (status.includes("Ошибка") || status === "Timeout") {
              accessErrors++;
            }
          }
        });

        const container = document.getElementById("friendshipStats");
        container.innerHTML = "";

        // Добавляем сводную информацию
        if (totalChecked > 0) {
          const summaryDiv = document.createElement("div");
          summaryDiv.innerHTML = `
                  <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #28a745; margin-bottom: 10px;">📊 Результаты проверки дружбы:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                      <div><strong>👥 Друзей найдено:</strong> <span style="color: #28a745; font-weight: bold;">${totalFriends}</span></div>
                      <div><strong>📋 Всего проверено:</strong> ${totalChecked}</div>
                      <div><strong>🎯 Процент дружбы:</strong> <span style="color: #4568dc; font-weight: bold;">${(
                        (totalFriends / totalChecked) *
                        100
                      ).toFixed(1)}%</span></div>
                      <div><strong>🔒 Закрытых профилей:</strong> ${closedProfiles}</div>
                    </div>
                    ${
                      accessErrors > 0
                        ? `<div style="margin-top: 10px; color: #dc3545;"><strong>⚠️ Ошибок доступа:</strong> ${accessErrors}</div>`
                        : ""
                    }
                  </div>
                `;
          container.appendChild(summaryDiv);
        }

        // Детальная статистика по статусам
        const sortedStats = Object.entries(friendStats).sort(
          ([, a], [, b]) => b - a
        );

        sortedStats.forEach(([status, count]) => {
          const percentage = ((count / users.length) * 100).toFixed(1);
          const statusDiv = document.createElement("div");

          // Определяем цвет и иконку для статуса
          let statusColor = "#666";
          let icon = "👤";

          if (status === "Друзья") {
            statusColor = "#28a745";
            icon = "✅";
          } else if (status === "Не друзья") {
            statusColor = "#6c757d";
            icon = "❌";
          } else if (status === "Профиль закрытый") {
            statusColor = "#ffc107";
            icon = "🔒";
          } else if (status.includes("Ошибка") || status === "Timeout") {
            statusColor = "#dc3545";
            icon = "⚠️";
          } else if (status === "Неизвестно") {
            statusColor = "#6c757d";
            icon = "❓";
          }

          statusDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <span>${icon} ${status}</span>
                    <span style="font-weight: bold; color: ${statusColor};">${count} (${percentage}%)</span>
                  </div>
                `;
          container.appendChild(statusDiv);
        });
      }

      // Вспомогательные функции
      function updateProgress() {
        const percent =
          (processingStats.processed / processingStats.total) * 100;
        document.getElementById("progressFill").style.width = percent + "%";
        document.getElementById(
          "progressText"
        ).textContent = `${processingStats.processed}/${processingStats.total}`;
      }

      function updateStats() {
        // Безопасное обновление статистики с проверками на null
        const updateElement = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        };

        updateElement("totalUsers", processingStats.total);
        updateElement("processedUsers", processingStats.processed);

        const cities = new Set(
          allResults.map((user) => user.city || "Не указан")
        );
        updateElement("uniqueCities", cities.size);

        const openProfiles = allResults.filter(
          (user) => user.profile_status === "Открытый"
        ).length;
        updateElement("openProfiles", openProfiles);

        const friendsCount = allResults.filter(
          (user) => user.friend_status === "Друзья"
        ).length;
        updateElement("friendsCount", friendsCount);

        const closedProfilesCount = allResults.filter(
          (user) => user.friend_status === "Профиль закрытый"
        ).length;
        updateElement("closedProfilesCount", closedProfilesCount);

        const onlineUsers = allResults.filter((user) => user.online).length;
        updateElement("onlineUsers", onlineUsers);
      }

      function showStatus(type, message) {
        const status = document.getElementById("status");
        status.className = `status ${type}`;
        status.textContent = message;
        status.style.display = "block";
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // Функция случайной задержки для избежания блокировки
      function getRandomDelay() {
        return (
          Math.floor(
            Math.random() * (API_CONFIG.MAX_DELAY - API_CONFIG.MIN_DELAY + 1)
          ) + API_CONFIG.MIN_DELAY
        );
      }
    </script>
  </body>
</html>
