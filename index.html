<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VK Users Analyzer Pro</title>
    <!-- SheetJS –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1em;
      }

      .main-content {
        padding: 30px;
      }

      .friend-check-section {
        background: #e8f5e8;
        border: 2px solid #28a745;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        text-align: center;
      }

      .friend-check-section h3 {
        color: #28a745;
        margin-bottom: 15px;
      }

      .friend-input {
        width: 100%;
        max-width: 500px;
        padding: 12px 20px;
        border: 2px solid #28a745;
        border-radius: 25px;
        font-size: 1.1em;
        margin-bottom: 15px;
      }

      .friend-input:focus {
        outline: none;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
      }

      .upload-section {
        background: #f8f9ff;
        border: 2px dashed #4568dc;
        border-radius: 15px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
      }

      .upload-section:hover {
        border-color: #b06ab3;
        background: #f0f2ff;
      }

      .file-input {
        display: none;
      }

      .upload-btn {
        background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 50px;
        font-size: 1.1em;
        cursor: pointer;
        transition: transform 0.3s ease;
        margin: 10px;
      }

      .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(69, 104, 220, 0.3);
      }

      .controls-section {
        background: #f8f9ff;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        display: none;
      }

      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      .control-group label {
        margin-bottom: 5px;
        font-weight: bold;
        color: #4568dc;
      }

      .control-group select,
      .control-group input {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
      }

      .control-group select:focus,
      .control-group input:focus {
        outline: none;
        border-color: #4568dc;
      }

      .view-toggle {
        display: flex;
        background: #e9ecef;
        border-radius: 25px;
        padding: 5px;
        margin: 15px 0;
      }

      .view-btn {
        flex: 1;
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: transparent;
      }

      .view-btn.active {
        background: #4568dc;
        color: white;
      }

      .progress-container {
        margin: 20px 0;
        display: none;
      }

      .progress-bar {
        background: #e0e0e0;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        background: linear-gradient(90deg, #4568dc, #b06ab3);
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin: 30px 0;
      }

      .stat-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #4568dc;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #4568dc;
      }

      .stat-label {
        color: #666;
        margin-top: 5px;
      }

      .results-container {
        margin-top: 30px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
      .city-section {
        margin-bottom: 30px;
      }

      .city-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .city-name {
        font-size: 1.3em;
        font-weight: bold;
      }

      .city-count {
        background: rgba(255, 255, 255, 0.2);
        padding: 5px 15px;
        border-radius: 20px;
      }

      .users-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 15px;
      }

      .user-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        transition: transform 0.2s ease;
      }

      .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      }

      .user-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
        border: 3px solid #f0f0f0;
      }

      .user-info h4 {
        color: #333;
        margin-bottom: 5px;
      }

      .user-info h4 a {
        color: #4568dc;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .user-info h4 a:hover {
        color: #b06ab3;
        text-decoration: underline;
      }

      .user-info p {
        color: #666;
        font-size: 0.9em;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
      .table-container {
        overflow-x: auto;
        margin-top: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: none;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      .results-table thead {
        background: linear-gradient(135deg, #4568dc 0%, #b06ab3 100%);
        color: white;
      }

      .results-table th,
      .results-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      .results-table th {
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.3s ease;
      }

      .results-table th:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .results-table tbody tr:hover {
        background-color: #f8f9ff;
      }

      .results-table .avatar-cell img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
      }

      .results-table .name-cell a {
        color: #4568dc;
        text-decoration: none;
        font-weight: bold;
      }

      .results-table .name-cell a:hover {
        color: #b06ab3;
        text-decoration: underline;
      }

      .status {
        padding: 10px 20px;
        border-radius: 10px;
        margin: 10px 0;
        text-align: center;
      }

      .status.info {
        background: #e3f2fd;
        color: #1976d2;
      }

      .status.success {
        background: #e8f5e8;
        color: #2e7d32;
      }

      .status.error {
        background: #ffebee;
        color: #c62828;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4568dc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .export-buttons {
        display: none;
        gap: 10px;
        margin-top: 20px;
      }

      .export-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .export-btn:hover {
        background: #218838;
      }

      .export-btn.xlsx {
        background: #17a2b8;
      }

      .export-btn.xlsx:hover {
        background: #138496;
      }

      .rate-limit-warning {
        background: #fff3cd;
        color: #856404;
        padding: 10px 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #ffc107;
      }

      .privacy-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .privacy-open {
        background: #d4edda;
        color: #155724;
      }

      .privacy-partial {
        background: #fff3cd;
        color: #856404;
      }

      .privacy-closed {
        background: #f8d7da;
        color: #721c24;
      }

      .friend-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 10px;
      }

      .friend-yes {
        background: #d1ecf1;
        color: #0c5460;
      }

      .friend-no {
        background: #f8d7da;
        color: #721c24;
      }

      .friend-unknown {
        background: #e2e3e5;
        color: #383d41;
      }

      .sort-indicator {
        margin-left: 5px;
        opacity: 0.5;
      }

      .sort-indicator.active {
        opacity: 1;
      }

      .analytics-section {
        margin-top: 40px;
        padding: 30px;
        background: #f8f9ff;
        border-radius: 20px;
        display: none;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .analytics-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .analytics-card h3 {
        color: #4568dc;
        margin-bottom: 15px;
        text-align: center;
      }

      .search-input {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 1em;
        margin-bottom: 20px;
      }

      .search-input:focus {
        outline: none;
        border-color: #4568dc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üîç VK Users Analyzer Pro</h1>
        <p>
          –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –í–ö–æ–Ω—Ç–∞–∫—Ç–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥—Ä—É–∑–µ–π –∏
          —ç–∫—Å–ø–æ—Ä—Ç–æ–º –≤ Excel
        </p>
      </div>

      <div class="main-content">
        <!-- –°–µ–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∑–µ–π -->
        <div class="friend-check-section">
          <h3>üë• –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∑–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
          <p>–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ VK –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</p>
          <p>
            <strong>–õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:</strong> —É –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
            –±—É–¥–µ–º —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –¥—Ä—É–∑—å—è—Ö –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –µ—Å—Ç—å –ª–∏ —Ç–∞–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
          </p>
          <input
            type="text"
            id="friendProfileInput"
            class="friend-input"
            placeholder="https://vk.com/id123456 –∏–ª–∏ https://vk.com/username"
          />
          <p>
            <small
              >‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π. –ó–∞–∫—Ä—ã—Ç—ã–µ
              –ø—Ä–æ—Ñ–∏–ª–∏ –±—É–¥—É—Ç –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ "–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–∫—Ä—ã—Ç—ã–π"</small
            >
          </p>
        </div>

        <div class="upload-section">
          <h3>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</h3>
          <p>
            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:<br />
            ‚Ä¢ <strong>profile_url</strong> - —Å—Å—ã–ª–∫–∏ –≤–∏–¥–∞ https://vk.com/id123
            –∏–ª–∏ https://vk.com/username<br />
            ‚Ä¢ <strong>id/user_id</strong> - –ø—Ä—è–º—ã–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br />
            ‚Ä¢ <strong>name</strong> - –∏–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          </p>
          <input type="file" id="csvFile" class="file-input" accept=".csv" />
          <button
            class="upload-btn"
            onclick="document.getElementById('csvFile').click()"
          >
            –í—ã–±—Ä–∞—Ç—å CSV —Ñ–∞–π–ª
          </button>
          <p>
            <small
              >–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: CSV —Å profile_url, id –∏–ª–∏ username</small
            >
          </p>
        </div>

        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="controls-section" id="controlsSection">
          <h3 style="color: #4568dc; margin-bottom: 20px">
            üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
          </h3>

          <div class="controls-grid">
            <div class="control-group">
              <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:</label>
              <select id="groupBySelect">
                <option value="city">–ü–æ –≥–æ—Ä–æ–¥—É</option>
                <option value="profile_status">–ü–æ —Å—Ç–∞—Ç—É—Å—É –ø—Ä–æ—Ñ–∏–ª—è</option>
                <option value="registration_period">
                  –ü–æ –ø–µ—Ä–∏–æ–¥—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                </option>
                <option value="friend_status">–ü–æ —Å—Ç–∞—Ç—É—Å—É –¥—Ä—É–∂–±—ã</option>
                <option value="none">–ë–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏</option>
              </select>
            </div>

            <div class="control-group">
              <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
              <select id="sortBySelect">
                <option value="first_name">–ü–æ –∏–º–µ–Ω–∏</option>
                <option value="last_name">–ü–æ —Ñ–∞–º–∏–ª–∏–∏</option>
                <option value="online">–ü–æ –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å—É</option>
                <option value="city">–ü–æ –≥–æ—Ä–æ–¥—É</option>
                <option value="id">–ü–æ ID</option>
                <option value="registration_date">
                  –ü–æ –ø–µ—Ä–∏–æ–¥—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                </option>
                <option value="exact_registration_date">–ü–æ —Ç–æ—á–Ω–æ–π –¥–∞—Ç–µ</option>
                <option value="profile_status">–ü–æ —Å—Ç–∞—Ç—É—Å—É –ø—Ä–æ—Ñ–∏–ª—è</option>
                <option value="friend_status">–ü–æ —Å—Ç–∞—Ç—É—Å—É –¥—Ä—É–∂–±—ã</option>
              </select>
            </div>

            <div class="control-group">
              <label>–ü–æ—Ä—è–¥–æ–∫:</label>
              <select id="sortOrderSelect">
                <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
              </select>
            </div>

            <div class="control-group">
              <label>–ü–æ–∏—Å–∫:</label>
              <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, –≥–æ—Ä–æ–¥—É..."
              />
            </div>
          </div>

          <div class="view-toggle">
            <button
              class="view-btn active"
              id="cardViewBtn"
              onclick="switchView('cards')"
            >
              üÉè –ö–∞—Ä—Ç–æ—á–∫–∏
            </button>
            <button
              class="view-btn"
              id="tableViewBtn"
              onclick="switchView('table')"
            >
              üìä –¢–∞–±–ª–∏—Ü–∞
            </button>
          </div>
        </div>

        <div class="rate-limit-warning">
          ‚ö†Ô∏è <strong>–õ–∏–º–∏—Ç—ã VK API (—Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏):</strong> <br />üìä
          <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–æ–∫–µ–Ω—ã:</strong> –¥–æ 3 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫, –±–∞—Ç—á–∏ –¥–æ
          100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π <br />üìç
          <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∑–µ–π:</strong> –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ 1 –∑–∞–ø—Ä–æ—Å—É –Ω–∞
          –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <br />üéØ
          <strong>–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:</strong> —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –±–∞—Ç—á–∏, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è API,
          –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫
        </div>

        <div class="progress-container" id="progressContainer">
          <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <span id="progressText">0/0</span></p>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <div class="stats-container" id="statsContainer" style="display: none">
          <div class="stat-card">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="processedUsers">0</div>
            <div class="stat-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="uniqueCities">0</div>
            <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="openProfiles">0</div>
            <div class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="friendsCount">0</div>
            <div class="stat-label">–í –¥—Ä—É–∑—å—è—Ö</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="oldestUsers">0</div>
            <div class="stat-label">–°—Ç–∞—Ä—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
          </div>
        </div>

        <div class="status" id="status" style="display: none"></div>

        <!-- –ö–∞—Ä—Ç–æ—á–Ω—ã–π —Ä–µ–∂–∏–º -->
        <div class="results-container" id="resultsContainer"></div>

        <!-- –¢–∞–±–ª–∏—á–Ω—ã–π —Ä–µ–∂–∏–º -->
        <div class="table-container" id="tableContainer">
          <table class="results-table" id="resultsTable">
            <thead>
              <tr>
                <th onclick="sortTable('avatar')">–§–æ—Ç–æ</th>
                <th onclick="sortTable('name')">
                  –ò–º—è <span class="sort-indicator">‚Üï</span>
                </th>
                <th onclick="sortTable('id')">
                  ID <span class="sort-indicator">‚Üï</span>
                </th>
                <th onclick="sortTable('online')">
                  –°—Ç–∞—Ç—É—Å <span class="sort-indicator">‚Üï</span>
                </th>
                <th onclick="sortTable('city')">
                  –ì–æ—Ä–æ–¥ <span class="sort-indicator">‚Üï</span>
                </th>
                <th onclick="sortTable('registration_date')">
                  –ü–µ—Ä–∏–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ <span class="sort-indicator">‚Üï</span>
                </th>
                <th onclick="sortTable('exact_registration_date')">
                  –¢–æ—á–Ω–∞—è –¥–∞—Ç–∞ <span class="sort-indicator">‚Üï</span>
                </th>
                <th onclick="sortTable('profile_status')">
                  –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å <span class="sort-indicator">‚Üï</span>
                </th>
                <th onclick="sortTable('friend_status')">
                  –î—Ä—É–∂–±–∞ <span class="sort-indicator">‚Üï</span>
                </th>
              </tr>
            </thead>
            <tbody id="resultsTableBody"></tbody>
          </table>
        </div>

        <div class="export-buttons" id="exportButtons">
          <button class="export-btn" onclick="exportResults('csv')">
            üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
          </button>
          <button class="export-btn xlsx" onclick="exportResults('xlsx')">
            üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
          </button>
        </div>

        <div class="analytics-section" id="analyticsSection">
          <h2 style="text-align: center; margin: 30px 0; color: #4568dc">
            üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
          </h2>
          <div class="analytics-grid">
            <div class="analytics-card">
              <h3>üèôÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º</h3>
              <div id="cityStats"></div>
            </div>
            <div class="analytics-card">
              <h3>üîí –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ–∏–ª–µ–π</h3>
              <div id="profileStats"></div>
            </div>
            <div class="analytics-card">
              <h3>üìÖ –ü–µ—Ä–∏–æ–¥—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h3>
              <div id="registrationStats"></div>
            </div>
            <div class="analytics-card">
              <h3>üë• –°—Ç–∞—Ç—É—Å –¥—Ä—É–∂–±—ã</h3>
              <div id="friendshipStats"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      const API_CONFIG = {
        ACCESS_TOKEN:
          "1bb263451bb263451bb2634552188a4cfe11bb21bb26345732659ed5d055a6b40f69c20",
        BASE_URL: "https://api.vk.com/method/",
        VERSION: "5.131",
        RATE_LIMIT: 2.5, // –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 3/—Å–µ–∫)
        BATCH_SIZE: 100, // users.get –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ ID
        FRIENDS_BATCH_SIZE: 25, // –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∑–µ–π –±–∞—Ç—á–∞–º–∏
        MIN_DELAY: 500, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 500–º—Å
        MAX_DELAY: 800, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 800–º—Å
      }; // ‚úÖ –ß–∏—Å—Ç–æ, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      let allResults = [];
      let filteredResults = [];
      let processingStats = {
        total: 0,
        processed: 0,
        errors: 0,
        duplicates: 0,
        invalidUrls: 0,
        resolveErrors: 0,
        resolveAttempts: 0,
        apiErrors: 0,
      };
      let friendCheckUserId = null;
      let currentView = "cards";
      let currentSort = { field: "first_name", order: "asc" };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      document
        .getElementById("csvFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            processCSV(file);
          }
        });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      document
        .getElementById("groupBySelect")
        .addEventListener("change", updateDisplay);
      document
        .getElementById("sortBySelect")
        .addEventListener("change", (e) => {
          currentSort.field = e.target.value;
          updateDisplay();
        });
      document
        .getElementById("sortOrderSelect")
        .addEventListener("change", (e) => {
          currentSort.order = e.target.value;
          updateDisplay();
        });
      document.getElementById("searchInput").addEventListener("input", (e) => {
        filterResults(e.target.value);
        updateDisplay();
      });

      // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CSV
      async function processCSV(file) {
        // –ü–æ–ª—É—á–∞–µ–º ID –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∑–µ–π
        const friendProfile = document
          .getElementById("friendProfileInput")
          .value.trim();
        if (friendProfile) {
          friendCheckUserId = await extractUserIdFromProfile(friendProfile);
          if (friendCheckUserId) {
            showStatus(
              "info",
              `–ë—É–¥–µ—Ç –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∂–±—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ID: ${friendCheckUserId}`
            );
          } else {
            showStatus(
              "error",
              "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∏–∑ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è"
            );
            return;
          }
        }

        showStatus("info", "–ó–∞–≥—Ä—É–∑–∫–∞ CSV —Ñ–∞–π–ª–∞...");

        const text = await file.text();
        const lines = text.split("\n").filter((line) => line.trim());

        if (lines.length === 0) {
          showStatus("error", "–§–∞–π–ª –ø—É—Å—Ç");
          return;
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ CSV
        function parseCSVLine(line) {
          const result = [];
          let current = "";
          let inQuotes = false;

          for (let i = 0; i < line.length; i++) {
            const char = line[i];

            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === "," && !inQuotes) {
              result.push(current.trim());
              current = "";
            } else {
              current += char;
            }
          }
          result.push(current.trim());
          return result;
        }

        const headers = parseCSVLine(lines[0]).map((h) =>
          h.toLowerCase().replace(/"/g, "")
        );
        let userDataIndex = -1;
        let nameIndex = -1;

        // –ü–æ–∏—Å–∫ —Å—Ç–æ–ª–±—Ü–æ–≤
        const urlColumns = ["profile_url", "url", "link", "vk_url", "vk_link"];
        const idColumns = ["id", "user_id", "userid", "vk_id", "vkid"];
        const nameColumns = ["name", "username", "full_name", "–∏–º—è"];

        // –ü–æ–∏—Å–∫ –Ω—É–∂–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
        for (let col of urlColumns) {
          const index = headers.findIndex((h) => h.includes(col));
          if (index !== -1) {
            userDataIndex = index;
            break;
          }
        }

        if (userDataIndex === -1) {
          for (let col of idColumns) {
            const index = headers.findIndex((h) => h.includes(col));
            if (index !== -1) {
              userDataIndex = index;
              break;
            }
          }
        }

        for (let col of nameColumns) {
          const index = headers.findIndex((h) => h.includes(col));
          if (index !== -1) {
            nameIndex = index;
            break;
          }
        }

        if (userDataIndex === -1) {
          showStatus("error", "–ù–µ –Ω–∞–π–¥–µ–Ω —Å—Ç–æ–ª–±–µ—Ü —Å ID/URL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
          return;
        }

        showStatus("info", "–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –¥–∞–Ω–Ω—ã—Ö...");

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ ID
        const userIds = [];
        const userNames = {};
        const invalidRows = [];
        let emptyRows = 0;

        showStatus("info", "–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–æ–∫ CSV —Ñ–∞–π–ª–∞...");

        for (let i = 1; i < lines.length; i++) {
          const cols = parseCSVLine(lines[i]);

          if (!cols[userDataIndex] || !cols[userDataIndex].trim()) {
            emptyRows++;
            continue;
          }

          const userData = cols[userDataIndex].replace(/"/g, "").trim();

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 100 —Å—Ç—Ä–æ–∫
          if (i % 100 === 0) {
            showStatus(
              "info",
              `–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä–æ–∫–∏ ${i} –∏–∑ ${lines.length - 1}... (–Ω–∞–π–¥–µ–Ω–æ ID: ${
                userIds.length
              })`
            );
          }

          let userId = await extractUserIdFromProfile(userData);

          if (userId) {
            userIds.push(userId);
            if (nameIndex !== -1 && cols[nameIndex]) {
              const name = cols[nameIndex].replace(/"/g, "").trim();
              if (name) {
                userNames[userId] = name;
              }
            }
          } else {
            invalidRows.push({
              row: i,
              data: userData,
              originalData: cols[userDataIndex], // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            });
            processingStats.invalidUrls++;
          }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å –ø–æ–¥—Å—á–µ—Ç–æ–º
        const uniqueIds = [];
        const seenIds = new Set();
        userIds.forEach((id) => {
          if (!seenIds.has(id)) {
            uniqueIds.push(id);
            seenIds.add(id);
          } else {
            processingStats.duplicates++;
          }
        });

        // –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
        let reportMessage = `
      üìä –ê–Ω–∞–ª–∏–∑ CSV –∑–∞–≤–µ—Ä—à–µ–Ω:
      ‚Ä¢ –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: ${lines.length - 1}
      ‚Ä¢ –ü—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫: ${emptyRows}
      ‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL/ID: ${processingStats.invalidUrls}
      ‚Ä¢ –î—É–±–ª–∏–∫–∞—Ç–æ–≤: ${processingStats.duplicates}
      ‚Ä¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${uniqueIds.length}
              `.trim();

        if (invalidRows.length > 0) {
          reportMessage += `\n\n‚ùå –ü—Ä–∏–º–µ—Ä—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å—Ç—Ä–æ–∫:`;
          invalidRows.slice(0, 5).forEach((invalid) => {
            const displayData = invalid.originalData || invalid.data;
            reportMessage += `\n‚Ä¢ –°—Ç—Ä–æ–∫–∞ ${invalid.row}: "${
              displayData.length > 50
                ? displayData.substring(0, 50) + "..."
                : displayData
            }"`;
          });
          if (invalidRows.length > 5) {
            reportMessage += `\n‚Ä¢ ... –∏ –µ—â–µ ${invalidRows.length - 5} —Å—Ç—Ä–æ–∫`;
          }
          reportMessage += `\n\nüí° –°–æ–≤–µ—Ç: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç URL - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è vk.com/username, vk.com/id123456, –∏ –ø—Ä—è–º—ã–µ ID`;
        }

        showStatus("info", reportMessage);

        processingStats = {
          total: uniqueIds.length,
          processed: 0,
          errors: 0,
          duplicates: processingStats.duplicates,
          invalidUrls: processingStats.invalidUrls,
          resolveErrors: processingStats.resolveErrors,
          resolveAttempts: processingStats.resolveAttempts || 0,
          apiErrors: 0,
        };

        updateStats();
        await processUsers(uniqueIds, userNames);
      }

      // –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ID –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≥–∏–±–∫–∏–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º
      async function extractUserIdFromProfile(userData) {
        if (!userData || userData === "") return null;

        // –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        userData = userData.trim().replace(/['"]/g, "");

        // –ü—Ä—è–º–æ–π ID - —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
        if (/^\d+$/.test(userData)) {
          return userData;
        }

        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ VK URL
        let username = null;

        // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è username/id –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ URL
        const patterns = [
          // –ü–æ–ª–Ω—ã–µ URL —Å https/http –∏ www/m
          /(?:https?:\/\/)(?:www\.|m\.)?vk\.com\/([^\/\?&#]+)/i,
          /(?:https?:\/\/)(?:www\.|m\.)?vkontakte\.ru\/([^\/\?&#]+)/i,

          // –ö–æ—Ä–æ—Ç–∫–∏–µ URL –±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
          /(?:www\.|m\.)?vk\.com\/([^\/\?&#]+)/i,
          /(?:www\.|m\.)?vkontakte\.ru\/([^\/\?&#]+)/i,

          // –ï—â–µ –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ–æ—Ä–º—ã
          /vk\.com\/([^\/\?&#]+)/i,
          /vkontakte\.ru\/([^\/\?&#]+)/i,

          // ID –≤ —Ñ–æ—Ä–º–∞—Ç–µ id123456
          /^id(\d+)$/i,

          // –ü—Ä–æ—Å—Ç–æ username –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
          /^([a-zA-Z0-9_.-]+)$/,
        ];

        // –ü—Ä–æ–±—É–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
        for (let pattern of patterns) {
          const match = userData.match(pattern);
          if (match && match[1]) {
            username = match[1].toLowerCase();
            break;
          }
        }

        if (!username) return null;

        // –ï—Å–ª–∏ —ç—Ç–æ ID —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "id"
        if (username.startsWith("id")) {
          const idMatch = username.match(/^id(\d+)$/);
          if (idMatch && idMatch[1]) {
            return idMatch[1];
          }
        }

        // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä—è–º–æ–π —á–∏—Å–ª–æ–≤–æ–π ID
        if (/^\d+$/.test(username)) {
          return username;
        }

        // –§–∏–ª—å—Ç—Ä—É–µ–º –æ—á–µ–≤–∏–¥–Ω–æ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–µ username'—ã
        if (username.length < 3 || username.length > 32) {
          return null;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è VK username
        if (!/^[a-zA-Z0-9_.-]+$/.test(username)) {
          return null;
        }

        // –†–µ–∑–æ–ª–≤–∏–º username —á–µ—Ä–µ–∑ API —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        try {
          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É —Ä–µ–∑–æ–ª–≤–∞–º–∏ —á—Ç–æ–±—ã –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è
          if (
            processingStats.resolveAttempts > 0 &&
            processingStats.resolveAttempts % 5 === 0
          ) {
            await sleep(200); // –ü–∞—É–∑–∞ –∫–∞–∂–¥—ã–µ 5 —Ä–µ–∑–æ–ª–≤–æ–≤
          }

          processingStats.resolveAttempts =
            (processingStats.resolveAttempts || 0) + 1;

          const resolvedId = await resolveUsernameWithJSONP(username);
          if (!resolvedId) {
            processingStats.resolveErrors++;
            console.warn(
              `–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑—Ä–µ—à–∏—Ç—å username: ${username} –∏–∑ ${userData}`
            );
          }
          return resolvedId;
        } catch (error) {
          processingStats.resolveErrors++;
          console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–∑–æ–ª–≤–µ username ${username}:`, error);
          return null;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      async function processUsers(userIds, csvNames = {}) {
        document.getElementById("progressContainer").style.display = "block";
        document.getElementById("statsContainer").style.display = "grid";
        document.getElementById("controlsSection").style.display = "block";

        allResults = [];

        // –†–µ–∑–æ–ª–≤–∏–º username'—ã
        const resolvedIds = userIds.filter((id) => id);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–∞—Ç—á–∞–º–∏
        for (let i = 0; i < resolvedIds.length; i += API_CONFIG.BATCH_SIZE) {
          const batch = resolvedIds.slice(i, i + API_CONFIG.BATCH_SIZE);

          try {
            const batchNumber = Math.floor(i / API_CONFIG.BATCH_SIZE) + 1;
            const totalBatches = Math.ceil(
              resolvedIds.length / API_CONFIG.BATCH_SIZE
            );

            showStatus(
              "info",
              `–û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–∞ ${batchNumber}/${totalBatches}: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ${
                i + 1
              }-${Math.min(i + API_CONFIG.BATCH_SIZE, resolvedIds.length)} –∏–∑ ${
                resolvedIds.length
              }...`
            );

            const users = await fetchUsersBatch(batch, csvNames);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–∂–±—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (friendCheckUserId && users.length > 0) {
              showStatus("info", `–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∑–µ–π –¥–ª—è –±–∞—Ç—á–∞ ${batchNumber}...`);
              await checkFriendship(users, friendCheckUserId);
            }

            allResults.push(...users);
            processingStats.processed += users.length;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateProgress();
            updateStats();

            // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏
            await sleep(getRandomDelay());
          } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –±–∞—Ç—á–∞:", error);
            processingStats.errors += batch.length;
            processingStats.apiErrors += batch.length;

            showStatus(
              "error",
              `–û—à–∏–±–∫–∞ –±–∞—Ç—á–∞ ${Math.floor(i / API_CONFIG.BATCH_SIZE) + 1}: ${
                error.message
              }`
            );

            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ª–µ–¥—É—é—â–∏—Ö –±–∞—Ç—á–µ–π
            await sleep(getRandomDelay() * 2); // –ë–æ–ª—å—à–µ –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
          }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ—Ç—á–µ—Ç–æ–º
        filteredResults = [...allResults];
        updateDisplay();
        displayAnalytics(allResults);

        const finalReport = `
        üéâ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

        üìä –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
        ‚Ä¢ –ö –æ–±—Ä–∞–±–æ—Ç–∫–µ: ${processingStats.total}
        ‚Ä¢ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processingStats.processed}
      ‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL: ${processingStats.invalidUrls}
      ‚Ä¢ –ü–æ–ø—ã—Ç–æ–∫ —Ä–µ–∑–æ–ª–≤–∞ username: ${processingStats.resolveAttempts || 0}
      ‚Ä¢ –û—à–∏–±–æ–∫ —Ä–µ–∑–æ–ª–≤–∞: ${processingStats.resolveErrors}
      ‚Ä¢ –î—É–±–ª–∏–∫–∞—Ç–æ–≤: ${processingStats.duplicates}
      ‚Ä¢ –ö –æ–±—Ä–∞–±–æ—Ç–∫–µ: ${processingStats.total}
      ‚Ä¢ –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processingStats.processed}
      ‚Ä¢ API –æ—à–∏–±–æ–∫: ${processingStats.apiErrors}

      ‚úÖ –ò—Ç–æ–≥–æ –≤ —Ç–∞–±–ª–∏—Ü–µ: ${allResults.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      ${
        friendCheckUserId
          ? `\nüë• –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∑–µ–π —Å ID ${friendCheckUserId} –∑–∞–≤–µ—Ä—à–µ–Ω–∞`
          : ""
      }

      ${
        invalidRows.length > 0
          ? `\nüîç –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ:
      ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö URL –≤ CSV
      ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–æ—Ñ–∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –¥–æ—Å—Ç—É–ø–Ω—ã
      ‚Ä¢ –ù–µ–∫–æ—Ç–æ—Ä—ã–µ username –º–æ–≥–ª–∏ –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω—ã –≤–ª–∞–¥–µ–ª—å—Ü–∞–º–∏`
          : ""
      }
              `.trim();

        showStatus("success", finalReport);
        document.getElementById("exportButtons").style.display = "flex";
      }

      // JSONP —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∑–æ–ª–≤–∞ username
      function resolveUsernameWithJSONP(username) {
        return new Promise((resolve, reject) => {
          const callbackName =
            "vk_callback_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);

          window[callbackName] = function (response) {
            document.head.removeChild(script);
            delete window[callbackName];

            if (response.error) {
              resolve(null);
              return;
            }

            if (response.response && response.response.type === "user") {
              resolve(response.response.object_id.toString());
            } else {
              resolve(null);
            }
          };

          const script = document.createElement("script");
          script.src = `${
            API_CONFIG.BASE_URL
          }utils.resolveScreenName?screen_name=${encodeURIComponent(
            username
          )}&access_token=${API_CONFIG.ACCESS_TOKEN}&v=${
            API_CONFIG.VERSION
          }&callback=${callbackName}`;

          script.onerror = function () {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve(null);
          };

          document.head.appendChild(script);

          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              resolve(null);
            }
          }, 10000);
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      async function fetchUsersBatch(userIds, csvNames = {}) {
        return new Promise((resolve, reject) => {
          const callbackName =
            "vk_users_callback_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);

          window[callbackName] = function (response) {
            document.head.removeChild(script);
            delete window[callbackName];

            if (response.error) {
              reject(new Error(response.error.error_msg));
              return;
            }

            const users = response.response.map((user) => {
              // –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
              let registrationPeriod = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
              let estimatedDate = null;
              let exactDate = null;

              if (user.id) {
                // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞—Ç—ã –ø–æ ID
                const id = user.id;

                if (id <= 50) {
                  registrationPeriod = "–û–∫—Ç—è–±—Ä—å 2006 (–û—Å–Ω–æ–≤–∞—Ç–µ–ª–∏)";
                  exactDate = "2006-10-10";
                } else if (id <= 100) {
                  registrationPeriod = "–ù–æ—è–±—Ä—å 2006 (–ü–µ—Ä–≤—ã–µ 100)";
                  exactDate = "2006-11-15";
                } else if (id <= 500) {
                  registrationPeriod = "–î–µ–∫–∞–±—Ä—å 2006";
                  exactDate = "2006-12-01";
                } else if (id <= 1000) {
                  registrationPeriod = "–Ø–Ω–≤–∞—Ä—å 2007";
                  exactDate = "2007-01-15";
                } else if (id <= 5000) {
                  registrationPeriod = "–§–µ–≤—Ä–∞–ª—å-–ú–∞—Ä—Ç 2007";
                  exactDate = "2007-02-15";
                } else if (id <= 10000) {
                  registrationPeriod = "–ê–ø—Ä–µ–ª—å-–ú–∞–π 2007";
                  exactDate = "2007-04-15";
                } else if (id <= 50000) {
                  registrationPeriod = "–õ–µ—Ç–æ 2007";
                  exactDate = "2007-07-01";
                } else if (id <= 100000) {
                  registrationPeriod = "–û—Å–µ–Ω—å 2007";
                  exactDate = "2007-09-15";
                } else if (id <= 500000) {
                  registrationPeriod = "–ó–∏–º–∞ 2007-2008";
                  exactDate = "2008-01-01";
                } else if (id <= 1000000) {
                  registrationPeriod = "–í–µ—Å–Ω–∞ 2008";
                  exactDate = "2008-04-01";
                } else if (id <= 5000000) {
                  registrationPeriod = "2008-2009";
                  exactDate = "2008-10-01";
                } else if (id <= 10000000) {
                  registrationPeriod = "2009-2010";
                  exactDate = "2009-06-01";
                } else if (id <= 25000000) {
                  registrationPeriod = "2010-2011";
                  exactDate = "2010-08-01";
                } else if (id <= 50000000) {
                  registrationPeriod = "2011-2012";
                  exactDate = "2011-10-01";
                } else if (id <= 100000000) {
                  registrationPeriod = "2012-2014";
                  exactDate = "2013-03-01";
                } else if (id <= 200000000) {
                  registrationPeriod = "2014-2016";
                  exactDate = "2015-01-01";
                } else if (id <= 300000000) {
                  registrationPeriod = "2016-2018";
                  exactDate = "2017-01-01";
                } else if (id <= 400000000) {
                  registrationPeriod = "2018-2020";
                  exactDate = "2019-01-01";
                } else if (id <= 500000000) {
                  registrationPeriod = "2020-2022";
                  exactDate = "2021-01-01";
                } else if (id <= 600000000) {
                  registrationPeriod = "2022-2023";
                  exactDate = "2022-06-01";
                } else {
                  registrationPeriod = "2023+";
                  exactDate = "2023-01-01";
                }

                estimatedDate = exactDate;
              }

              let profileStatus = "–û—Ç–∫—Ä—ã—Ç—ã–π";
              if (user.is_closed) {
                profileStatus = user.can_access_closed
                  ? "–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã–π"
                  : "–ó–∞–∫—Ä—ã—Ç—ã–π";
              }

              const csvName =
                csvNames[user.id] || csvNames[user.domain] || null;
              const firstName = csvName
                ? csvName.split(" ")[0]
                : user.first_name;
              const lastName = csvName
                ? csvName.split(" ").slice(1).join(" ")
                : user.last_name;

              return {
                id: user.id,
                first_name: firstName,
                last_name: lastName,
                photo: user.photo_50,
                city: user.city ? user.city.title : null,
                registration_period: registrationPeriod,
                registration_date: estimatedDate,
                exact_registration_date: exactDate,
                profile_status: profileStatus,
                is_closed: user.is_closed || false,
                domain: user.domain || user.screen_name || null,
                csv_name: csvName,
                friend_status: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
                vk_url: `https://vk.com/id${user.id}`,
                last_seen: user.last_seen
                  ? new Date(user.last_seen.time * 1000).toLocaleDateString(
                      "ru-RU"
                    )
                  : null,
                online: user.online || 0,
              };
            });

            resolve(users);
          };

          const script = document.createElement("script");
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
          const fields =
            "city,photo_50,can_access_closed,is_closed,domain,screen_name,last_seen,online";
          script.src = `${API_CONFIG.BASE_URL}users.get?user_ids=${userIds.join(
            ","
          )}&fields=${fields}&access_token=${API_CONFIG.ACCESS_TOKEN}&v=${
            API_CONFIG.VERSION
          }&callback=${callbackName}`;

          script.onerror = function () {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞"));
          };

          document.head.appendChild(script);

          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error("Timeout –∑–∞–ø—Ä–æ—Å–∞"));
            }
          }, 15000);
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∂–±—ã - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
      async function checkFriendship(users, checkUserId) {
        if (!checkUserId) return users;

        showStatus(
          "info",
          `–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∂–±—ã —É ${users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...`
        );

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞—Ç—á–∞–º–∏, –Ω–æ –ø–æ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        for (let i = 0; i < users.length; i++) {
          const user = users[i];

          try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (i % 10 === 0) {
              showStatus(
                "info",
                `–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∑–µ–π: ${i + 1}/${users.length} (${
                  user.first_name
                } ${user.last_name})`
              );
            }

            const friendStatus = await checkUserFriends(user.id, checkUserId);
            user.friend_status = friendStatus;

            // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await sleep(getRandomDelay());
          } catch (error) {
            console.error(
              `–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∑–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.id}:`,
              error
            );
            user.friend_status = "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏";
          }
        }

        return users;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—Ä—É–∑–µ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ API
      function checkUserFriends(userId, targetId) {
        return new Promise((resolve, reject) => {
          const callbackName =
            "vk_user_friends_" +
            Date.now() +
            "_" +
            Math.random().toString(36).substr(2, 9);

          window[callbackName] = function (response) {
            document.head.removeChild(script);
            delete window[callbackName];

            if (response.error) {
              // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ VK API
              switch (response.error.error_code) {
                case 30: // Profile is private
                  resolve("–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–∫—Ä—ã—Ç—ã–π");
                  break;
                case 18: // User was deleted or banned
                  resolve("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
                  break;
                case 15: // Access denied
                  resolve("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω");
                  break;
                case 6: // Too many requests per second
                  resolve("–õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤");
                  break;
                default:
                  resolve("–û—à–∏–±–∫–∞ API: " + response.error.error_msg);
              }
              return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ targetId –≤ —Å–ø–∏—Å–∫–µ –¥—Ä—É–∑–µ–π
            if (response.response && response.response.items) {
              const isFriend = response.response.items.includes(
                parseInt(targetId)
              );
              resolve(isFriend ? "–î—Ä—É–∑—å—è" : "–ù–µ –¥—Ä—É–∑—å—è");
            } else if (response.response && Array.isArray(response.response)) {
              // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ ID)
              const isFriend = response.response.includes(parseInt(targetId));
              resolve(isFriend ? "–î—Ä—É–∑—å—è" : "–ù–µ –¥—Ä—É–∑—å—è");
            } else {
              resolve("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥—Ä—É–∑—å—è—Ö");
            }
          };

          const script = document.createElement("script");
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ friends.get
          script.src = `${API_CONFIG.BASE_URL}friends.get?user_id=${userId}&count=5000&access_token=${API_CONFIG.ACCESS_TOKEN}&v=${API_CONFIG.VERSION}&callback=${callbackName}`;

          script.onerror = function () {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
          };

          document.head.appendChild(script);

          // Timeout —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
          setTimeout(() => {
            if (window[callbackName]) {
              document.head.removeChild(script);
              delete window[callbackName];
              resolve("Timeout");
            }
          }, 10000);
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      function switchView(viewType) {
        currentView = viewType;

        const cardViewBtn = document.getElementById("cardViewBtn");
        const tableViewBtn = document.getElementById("tableViewBtn");
        const resultsContainer = document.getElementById("resultsContainer");
        const tableContainer = document.getElementById("tableContainer");

        if (viewType === "cards") {
          cardViewBtn.classList.add("active");
          tableViewBtn.classList.remove("active");
          resultsContainer.style.display = "block";
          tableContainer.style.display = "none";
        } else {
          tableViewBtn.classList.add("active");
          cardViewBtn.classList.remove("active");
          resultsContainer.style.display = "none";
          tableContainer.style.display = "block";
        }

        updateDisplay();
      }

      // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      function filterResults(searchTerm) {
        if (!searchTerm.trim()) {
          filteredResults = [...allResults];
          return;
        }

        const term = searchTerm.toLowerCase();
        filteredResults = allResults.filter((user) => {
          return (
            user.first_name.toLowerCase().includes(term) ||
            user.last_name.toLowerCase().includes(term) ||
            (user.city && user.city.toLowerCase().includes(term)) ||
            user.id.toString().includes(term) ||
            user.profile_status.toLowerCase().includes(term) ||
            user.friend_status.toLowerCase().includes(term)
          );
        });
      }

      // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      function sortResults(results) {
        return [...results].sort((a, b) => {
          let aVal = a[currentSort.field];
          let bVal = b[currentSort.field];

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å–æ–±—ã—Ö —Å–ª—É—á–∞–µ–≤
          if (currentSort.field === "name") {
            aVal = a.first_name + " " + a.last_name;
            bVal = b.first_name + " " + b.last_name;
          }

          if (aVal === null || aVal === undefined) aVal = "";
          if (bVal === null || bVal === undefined) bVal = "";

          // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
          let comparison = 0;
          if (typeof aVal === "string" && typeof bVal === "string") {
            comparison = aVal.localeCompare(bVal, "ru");
          } else {
            comparison = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
          }

          return currentSort.order === "desc" ? -comparison : comparison;
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      function updateDisplay() {
        const groupBy = document.getElementById("groupBySelect").value;
        let displayResults = sortResults(filteredResults);

        if (currentView === "cards") {
          displayCardsView(displayResults, groupBy);
        } else {
          displayTableView(displayResults);
        }
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º–µ –∫–∞—Ä—Ç–æ—á–µ–∫
      function displayCardsView(results, groupBy) {
        const container = document.getElementById("resultsContainer");
        container.innerHTML = "";

        if (groupBy === "none") {
          // –ë–µ–∑ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
          const usersGrid = document.createElement("div");
          usersGrid.className = "users-grid";

          results.forEach((user) => {
            usersGrid.appendChild(createUserCard(user));
          });

          container.appendChild(usersGrid);
        } else {
          // –° –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
          const groups = {};
          results.forEach((user) => {
            const groupKey = user[groupBy] || "–ù–µ —É–∫–∞–∑–∞–Ω–æ";
            if (!groups[groupKey]) groups[groupKey] = [];
            groups[groupKey].push(user);
          });

          const sortedGroups = Object.entries(groups).sort(
            ([, a], [, b]) => b.length - a.length
          );

          sortedGroups.forEach(([groupName, users]) => {
            const citySection = document.createElement("div");
            citySection.className = "city-section";

            const cityHeader = document.createElement("div");
            cityHeader.className = "city-header";
            cityHeader.innerHTML = `
                    <span class="city-name">${groupName}</span>
                    <span class="city-count">${users.length} —á–µ–ª.</span>
                  `;

            const usersGrid = document.createElement("div");
            usersGrid.className = "users-grid";

            users.forEach((user) => {
              usersGrid.appendChild(createUserCard(user));
            });

            citySection.appendChild(cityHeader);
            citySection.appendChild(usersGrid);
            container.appendChild(citySection);
          });
        }
      }

      // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      function createUserCard(user) {
        const userCard = document.createElement("div");
        userCard.className = "user-card";

        let privacyClass = "privacy-open";
        if (user.profile_status === "–ó–∞–∫—Ä—ã—Ç—ã–π") privacyClass = "privacy-closed";
        else if (user.profile_status === "–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã–π")
          privacyClass = "privacy-partial";

        let friendBadge = "";
        if (user.friend_status !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") {
          let friendClass = "friend-unknown";
          if (user.friend_status === "–î—Ä—É–∑—å—è") friendClass = "friend-yes";
          else if (user.friend_status === "–ù–µ –¥—Ä—É–∑—å—è")
            friendClass = "friend-no";

          friendBadge = `<span class="friend-badge ${friendClass}">${user.friend_status}</span>`;
        }

        userCard.innerHTML = `
                <img src="${user.photo || "https://via.placeholder.com/50"}"
                     alt="${user.first_name}"
                     class="user-avatar"
                     onerror="this.src='https://via.placeholder.com/50'">
                <div class="user-info">
                    <h4><a href="${user.vk_url}" target="_blank">${
          user.first_name
        } ${user.last_name}</a> ${user.online ? "üü¢" : ""}</h4>
                    <p>ID: ${user.id} | ${user.city || "–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω"}</p>
                    <p>üìÖ ${user.registration_period}</p>
                    ${
                      user.exact_registration_date
                        ? `<p style="font-size: 0.85em; color: #555;">–¢–æ—á–Ω–∞—è –¥–∞—Ç–∞: ${user.exact_registration_date}</p>`
                        : ""
                    }
                    ${
                      user.last_seen
                        ? `<p style="font-size: 0.85em; color: #666;">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç: ${user.last_seen}</p>`
                        : ""
                    }
                    ${
                      user.csv_name
                        ? `<p style="font-size: 0.8em; color: #888;">CSV: ${user.csv_name}</p>`
                        : ""
                    }
                    <div style="margin-top: 8px;">
                      <span class="privacy-badge ${privacyClass}">${
          user.profile_status
        }</span>
                      ${friendBadge}
                    </div>
                </div>
              `;
        return userCard;
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
      function displayTableView(results) {
        const tbody = document.getElementById("resultsTableBody");
        tbody.innerHTML = "";

        results.forEach((user) => {
          const row = document.createElement("tr");

          let privacyClass = "privacy-open";
          if (user.profile_status === "–ó–∞–∫—Ä—ã—Ç—ã–π")
            privacyClass = "privacy-closed";
          else if (user.profile_status === "–ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã–π")
            privacyClass = "privacy-partial";

          let friendClass = "friend-unknown";
          if (user.friend_status === "–î—Ä—É–∑—å—è") friendClass = "friend-yes";
          else if (user.friend_status === "–ù–µ –¥—Ä—É–∑—å—è")
            friendClass = "friend-no";

          row.innerHTML = `
                  <td class="avatar-cell">
                    <img src="${user.photo || "https://via.placeholder.com/40"}"
                         alt="${user.first_name}"
                         onerror="this.src='https://via.placeholder.com/40'">
                  </td>
                  <td class="name-cell">
                    <a href="${user.vk_url}" target="_blank">${
            user.first_name
          } ${user.last_name}</a>
                    ${
                      user.csv_name
                        ? `<br><small style="color: #888;">CSV: ${user.csv_name}</small>`
                        : ""
                    }
                  </td>
                  <td>${user.id}</td>
                  <td>
                    ${
                      user.online
                        ? '<span style="color: #28a745;">üü¢ –û–Ω–ª–∞–π–Ω</span>'
                        : '<span style="color: #6c757d;">‚ö´ –û—Ñ—Ñ–ª–∞–π–Ω</span>'
                    }
                    ${
                      user.last_seen
                        ? `<br><small style="color: #888;">${user.last_seen}</small>`
                        : ""
                    }
                  </td>
                  <td>${user.city || "–ù–µ —É–∫–∞–∑–∞–Ω"}</td>
                  <td>${user.registration_period}</td>
                  <td>${
                    user.exact_registration_date ||
                    user.registration_date ||
                    "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                  }</td>
                  <td><span class="privacy-badge ${privacyClass}">${
            user.profile_status
          }</span></td>
                  <td><span class="friend-badge ${friendClass}">${
            user.friend_status
          }</span></td>
                `;

          tbody.appendChild(row);
        });
      }

      // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
      function sortTable(field) {
        if (field === "name") field = "first_name";
        if (field === "avatar") return; // –ù–µ–ª—å–∑—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ —Ñ–æ—Ç–æ

        if (currentSort.field === field) {
          currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
        } else {
          currentSort.field = field;
          currentSort.order = "asc";
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
        document.getElementById("sortBySelect").value = field;
        document.getElementById("sortOrderSelect").value = currentSort.order;

        updateDisplay();
      }

      // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      function exportResults(format) {
        if (format === "csv") {
          exportToCSV();
        } else if (format === "xlsx") {
          exportToXLSX();
        }
      }

      function exportToCSV() {
        let csv =
          "–ò–º—è,–§–∞–º–∏–ª–∏—è,ID,–û–Ω–ª–∞–π–Ω,–ì–æ—Ä–æ–¥,–ü–µ—Ä–∏–æ–¥_—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏,–¢–æ—á–Ω–∞—è_–¥–∞—Ç–∞_—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏,–ü–æ—Å–ª–µ–¥–Ω–∏–π_–≤–∏–∑–∏—Ç,–°—Ç–∞—Ç—É—Å_–ø—Ä–æ—Ñ–∏–ª—è,–°—Ç–∞—Ç—É—Å_–¥—Ä—É–∂–±—ã,–°—Å—ã–ª–∫–∞,–§–æ—Ç–æ\n";

        filteredResults.forEach((user) => {
          const onlineStatus = user.online ? "–û–Ω–ª–∞–π–Ω" : "–û—Ñ—Ñ–ª–∞–π–Ω";
          csv += `"${user.first_name}","${user.last_name}",${
            user.id
          },"${onlineStatus}","${user.city || "–ù–µ —É–∫–∞–∑–∞–Ω"}","${
            user.registration_period
          }","${user.exact_registration_date || user.registration_date}","${
            user.last_seen || ""
          }","${user.profile_status}","${user.friend_status}","${
            user.vk_url
          }","${user.photo || ""}"\n`;
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        downloadFile(
          blob,
          `vk_users_analysis_${new Date().toISOString().split("T")[0]}.csv`
        );
      }

      function exportToXLSX() {
        const ws_data = [
          [
            "–ò–º—è",
            "–§–∞–º–∏–ª–∏—è",
            "ID",
            "–û–Ω–ª–∞–π–Ω",
            "–ì–æ—Ä–æ–¥",
            "–ü–µ—Ä–∏–æ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
            "–¢–æ—á–Ω–∞—è –¥–∞—Ç–∞",
            "–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç",
            "–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ–∏–ª—è",
            "–°—Ç–∞—Ç—É—Å –¥—Ä—É–∂–±—ã",
            "–°—Å—ã–ª–∫–∞",
            "–§–æ—Ç–æ",
          ],
        ];

        filteredResults.forEach((user) => {
          const onlineStatus = user.online ? "–û–Ω–ª–∞–π–Ω" : "–û—Ñ—Ñ–ª–∞–π–Ω";
          ws_data.push([
            user.first_name,
            user.last_name,
            user.id,
            onlineStatus,
            user.city || "–ù–µ —É–∫–∞–∑–∞–Ω",
            user.registration_period,
            user.exact_registration_date || user.registration_date,
            user.last_seen || "",
            user.profile_status,
            user.friend_status,
            user.vk_url,
            user.photo || "",
          ]);
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(ws_data);

        // –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫
        const colWidths = [];
        for (let i = 0; i < ws_data[0].length; i++) {
          let maxLength = 0;
          for (let j = 0; j < ws_data.length; j++) {
            if (ws_data[j][i]) {
              maxLength = Math.max(maxLength, ws_data[j][i].toString().length);
            }
          }
          colWidths.push({ width: Math.min(maxLength + 2, 50) });
        }
        ws["!cols"] = colWidths;

        XLSX.utils.book_append_sheet(wb, ws, "VK Users");

        XLSX.writeFile(
          wb,
          `vk_users_analysis_${new Date().toISOString().split("T")[0]}.xlsx`
        );
      }

      function downloadFile(blob, filename) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }

      // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
      function displayAnalytics(users) {
        document.getElementById("analyticsSection").style.display = "block";

        displayCityAnalytics(users);
        displayProfileAnalytics(users);
        displayRegistrationAnalytics(users);
        displayFriendshipAnalytics(users);
      }

      function displayCityAnalytics(users) {
        const cityStats = {};
        users.forEach((user) => {
          const city = user.city || "–ù–µ —É–∫–∞–∑–∞–Ω";
          cityStats[city] = (cityStats[city] || 0) + 1;
        });

        const container = document.getElementById("cityStats");
        container.innerHTML = "";

        const sortedCities = Object.entries(cityStats)
          .sort(([, a], [, b]) => b - a)
          .slice(0, 10);

        sortedCities.forEach(([city, count]) => {
          const cityDiv = document.createElement("div");
          cityDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <span>${city}</span>
                    <span style="font-weight: bold; color: #4568dc;">${count}</span>
                  </div>
                `;
          container.appendChild(cityDiv);
        });
      }

      function displayProfileAnalytics(users) {
        const profileStats = {};
        users.forEach((user) => {
          const status = user.profile_status;
          profileStats[status] = (profileStats[status] || 0) + 1;
        });

        const container = document.getElementById("profileStats");
        container.innerHTML = "";

        Object.entries(profileStats).forEach(([status, count]) => {
          const percentage = ((count / users.length) * 100).toFixed(1);
          const statusDiv = document.createElement("div");
          statusDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span>${status}</span>
                    <span style="font-weight: bold; color: #4568dc;">${count} (${percentage}%)</span>
                  </div>
                `;
          container.appendChild(statusDiv);
        });
      }

      function displayRegistrationAnalytics(users) {
        const regStats = {};
        users.forEach((user) => {
          const period = user.registration_period;
          regStats[period] = (regStats[period] || 0) + 1;
        });

        const container = document.getElementById("registrationStats");
        container.innerHTML = "";

        const sortedPeriods = Object.entries(regStats).sort(([a], [b]) =>
          a.localeCompare(b)
        );

        sortedPeriods.forEach(([period, count]) => {
          const percentage = ((count / users.length) * 100).toFixed(1);
          const periodDiv = document.createElement("div");
          periodDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                    <span>${period}</span>
                    <span style="font-weight: bold; color: #4568dc;">${count} (${percentage}%)</span>
                  </div>
                `;
          container.appendChild(periodDiv);
        });
      }

      function displayFriendshipAnalytics(users) {
        const friendStats = {};
        let totalFriends = 0;
        let totalChecked = 0;
        let closedProfiles = 0;
        let accessErrors = 0;

        users.forEach((user) => {
          const status = user.friend_status;
          friendStats[status] = (friendStats[status] || 0) + 1;

          if (status !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") {
            totalChecked++;
            if (status === "–î—Ä—É–∑—å—è") {
              totalFriends++;
            } else if (status === "–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–∫—Ä—ã—Ç—ã–π") {
              closedProfiles++;
            } else if (status.includes("–û—à–∏–±–∫–∞") || status === "Timeout") {
              accessErrors++;
            }
          }
        });

        const container = document.getElementById("friendshipStats");
        container.innerHTML = "";

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        if (totalChecked > 0) {
          const summaryDiv = document.createElement("div");
          summaryDiv.innerHTML = `
                  <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #28a745; margin-bottom: 10px;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∂–±—ã:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                      <div><strong>üë• –î—Ä—É–∑–µ–π –Ω–∞–π–¥–µ–Ω–æ:</strong> <span style="color: #28a745; font-weight: bold;">${totalFriends}</span></div>
                      <div><strong>üìã –í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:</strong> ${totalChecked}</div>
                      <div><strong>üéØ –ü—Ä–æ—Ü–µ–Ω—Ç –¥—Ä—É–∂–±—ã:</strong> <span style="color: #4568dc; font-weight: bold;">${(
                        (totalFriends / totalChecked) *
                        100
                      ).toFixed(1)}%</span></div>
                      <div><strong>üîí –ó–∞–∫—Ä—ã—Ç—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π:</strong> ${closedProfiles}</div>
                    </div>
                    ${
                      accessErrors > 0
                        ? `<div style="margin-top: 10px; color: #dc3545;"><strong>‚ö†Ô∏è –û—à–∏–±–æ–∫ –¥–æ—Å—Ç—É–ø–∞:</strong> ${accessErrors}</div>`
                        : ""
                    }
                  </div>
                `;
          container.appendChild(summaryDiv);
        }

        // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        const sortedStats = Object.entries(friendStats).sort(
          ([, a], [, b]) => b - a
        );

        sortedStats.forEach(([status, count]) => {
          const percentage = ((count / users.length) * 100).toFixed(1);
          const statusDiv = document.createElement("div");

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ –∏–∫–æ–Ω–∫—É –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
          let statusColor = "#666";
          let icon = "üë§";

          if (status === "–î—Ä—É–∑—å—è") {
            statusColor = "#28a745";
            icon = "‚úÖ";
          } else if (status === "–ù–µ –¥—Ä—É–∑—å—è") {
            statusColor = "#6c757d";
            icon = "‚ùå";
          } else if (status === "–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–∫—Ä—ã—Ç—ã–π") {
            statusColor = "#ffc107";
            icon = "üîí";
          } else if (status.includes("–û—à–∏–±–∫–∞") || status === "Timeout") {
            statusColor = "#dc3545";
            icon = "‚ö†Ô∏è";
          } else if (status === "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") {
            statusColor = "#6c757d";
            icon = "‚ùì";
          }

          statusDiv.innerHTML = `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                    <span>${icon} ${status}</span>
                    <span style="font-weight: bold; color: ${statusColor};">${count} (${percentage}%)</span>
                  </div>
                `;
          container.appendChild(statusDiv);
        });
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      function updateProgress() {
        const percent =
          (processingStats.processed / processingStats.total) * 100;
        document.getElementById("progressFill").style.width = percent + "%";
        document.getElementById(
          "progressText"
        ).textContent = `${processingStats.processed}/${processingStats.total}`;
      }

      function updateStats() {
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –Ω–∞ null
        const updateElement = (id, value) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = value;
          }
        };

        updateElement("totalUsers", processingStats.total);
        updateElement("processedUsers", processingStats.processed);

        const cities = new Set(
          allResults.map((user) => user.city || "–ù–µ —É–∫–∞–∑–∞–Ω")
        );
        updateElement("uniqueCities", cities.size);

        const openProfiles = allResults.filter(
          (user) => user.profile_status === "–û—Ç–∫—Ä—ã—Ç—ã–π"
        ).length;
        updateElement("openProfiles", openProfiles);

        const friendsCount = allResults.filter(
          (user) => user.friend_status === "–î—Ä—É–∑—å—è"
        ).length;
        updateElement("friendsCount", friendsCount);

        const closedProfilesCount = allResults.filter(
          (user) => user.friend_status === "–ü—Ä–æ—Ñ–∏–ª—å –∑–∞–∫—Ä—ã—Ç—ã–π"
        ).length;
        updateElement("closedProfilesCount", closedProfilesCount);

        const onlineUsers = allResults.filter((user) => user.online).length;
        updateElement("onlineUsers", onlineUsers);
      }

      function showStatus(type, message) {
        const status = document.getElementById("status");
        status.className = `status ${type}`;
        status.textContent = message;
        status.style.display = "block";
      }

      function sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      // –§—É–Ω–∫—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      function getRandomDelay() {
        return (
          Math.floor(
            Math.random() * (API_CONFIG.MAX_DELAY - API_CONFIG.MIN_DELAY + 1)
          ) + API_CONFIG.MIN_DELAY
        );
      }
    </script>
  </body>
</html>
